<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>授权码管理系统（带登录·无多余符号）</title>
<style>
/* 完全沿用你文档中的极致精简样式，无任何修改 */
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif}
body{background:#f3f3f3;color:#333;padding:10px}
/* 新增登录面板样式（适配精简风格） */
.login-panel{background:#fff;padding:15px;border-radius:4px;margin:10px 0;display:block}
.login-panel h3{font-size:15px;margin-bottom:10px;color:#333}
.login-input{width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:14px;margin-bottom:8px}
.login-btn{width:100%;background:#7d2ae8;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:14px;margin-top:5px}
.login-btn:hover{background:#6b23c2}
.login-tip{font-size:12px;color:#dc3545;margin-top:8px;text-align:center}
/* 生成区域（默认隐藏，登录后显示） */
.generate-area{display:none;gap:10px;margin:10px 0;align-items:center}
.generate-area select{flex:1;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:14px}
button{background:#7d2ae8;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:14px}
button:hover{background:#6b23c2}
button.delete-btn{background:#dc3545}
button.delete-btn:hover{background:#bb2d3b}
.container{width:100%;overflow-x:auto;display:none}/* 默认隐藏 */
table{width:100%;min-width:900px;border-collapse:collapse;margin:10px 0}
th,td{padding:8px 6px;text-align:left;border:1px solid #ddd;font-size:14px;word-break:break-word}
th{background:#e9d5ff;position:sticky;top:0;z-index:1}
.status{padding:2px 6px;border-radius:4px;color:#fff;font-size:12px;display:inline-block}
.unbound{background:#4ecdc4}
.bound{background:#17a2b8}
.expired{background:#ffc107;color:#333}
.permanent{background:#7d2ae8}
.use-status{padding:2px 6px;border-radius:4px;font-size:12px;display:inline-block}
.used{background:#28a745;color:#fff}
.unused{background:#6c757d;color:#fff}
.countdown{font-family:monospace;color:#dc3545;font-weight:500}
.countdown.expired{color:#dc3545}
.countdown.active{color:#28a745}
input[type=text]{width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:4px;font-size:13px}
/* 弹窗样式：完全沿用你文档的核心结构 */
#codeToast {position:fixed;bottom:20px;right:20px;background:white;border:1px solid #eee;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);padding:12px 16px;width:320px;z-index:100;display:none}
#codeToast .title{font-size:14px;color:#333;margin-bottom:8px;font-weight:500}
#codeToast .auth-code{font-family:monospace;font-size:16px;color:#7d2ae8;padding:6px 10px;background:#f9f5ff;border-radius:4px;margin-bottom:10px;word-break:break-all}
#codeToast .tip{font-size:12px;color:#666;margin-bottom:10px}
#codeToast .btn-group{display:flex;gap:8px;justify-content:flex-end}
#codeToast .btn-group button{padding:4px 10px;font-size:12px}
#loading{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.5);color:white;padding:8px 16px;border-radius:4px;font-size:14px;z-index:200;display:none}
</style>
</head>
<body>
<!-- 1. 登录面板（默认显示，无多余符号） -->
<div class="login-panel" id="loginPanel">
  <h3>管理员登录</h3>
  <input type="email" id="loginEmail" class="login-input" placeholder="Firebase邮箱">
  <input type="password" id="loginPwd" class="login-input" placeholder="Firebase密码">
  <button class="login-btn" onclick="handleLogin()">登录</button>
  <div class="login-tip" id="loginTip"></div>
</div>

<!-- 2. 生成+表格区域（默认隐藏，登录后显示，完全沿用你文档的标签结构） -->
<div class="generate-area" id="generateArea">
<select id="authType">
<option value="permanent">永久授权</option>
<option value="day">1天授权</option>
<option value="week">7天授权</option>
<option value="month">30天授权</option>
</select>
<button id="generateBtn">生成授权码</button>
</div>
<div class="container" id="tableContainer">
<table>
<thead>
<tr>
<th>授权码</</th>
<th>使用状态</</th>
<th>首次使用时间</</th>
<th>剩余时间（精确到秒）</</th>
<th>状态</</th>
<th>时长</</th>
<th>到期时间</</th>
<th>本地随机码</</th>
<th>备注</</th>
<th>管理操作</</th>
</tr>
</thead>
<tbody id="authTableBody"></tbody>
</table>
</div>

<!-- 弹窗：完全沿用你文档的结构 -->
<div id="codeToast">
  <div class="title">授权码生成成功</div>
  <div class="auth-code" id="currentAuthCode"></div>
  <div class="tip" id="copyTip">已自动复制到剪贴板</div>
  <div class="btn-group">
    <button onclick="window.copyCurrentCode()">重新复制</button>
    <button onclick="document.getElementById('codeToast').style.display='none'">关闭</button>
  </div>
</div>
<div id="loading">处理中...</div>

<!-- 全局函数壳：完全沿用你文档的逻辑 -->
<script>
window.deleteAuthCode = (authId) => window.__authModule?.deleteAuthCode(authId);
window.copyCurrentCode = () => window.__authModule?.copyCurrentCode();
window.updateRemark = (authId, remark) => window.__authModule?.updateRemark(authId, remark);
window.verifyAuthCode = (code) => window.__authModule?.verifyAuthCode(code);
window.onVerifyResult = (success, message) => { alert(message); };
window.__authModule = {};
</script>

<!-- Firebase 脚本：整合登录逻辑，保留你文档的所有优化 -->
<script type="module">
  // 1. 基础配置（你的Firebase信息+管理员UID）
  const CONFIG = {
    FIREBASE: {
      apiKey: "AIzaSyBd88UKHBOUpyHCtMXt1vliPN_F_9-Eh-0",
      authDomain: "card-verify-system.firebaseapp.com",
      databaseURL: "https://card-verify-system-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "card-verify-system",
      storageBucket: "card-verify-system.firebasestorage.app",
      messagingSenderId: "868161283502",
      appId: "1:868161283502:web:dcb52c1ce9074eb103143f",
      measurementId: "G-TEE7RMEVSE"
    },
    ADMIN_UID: "mXN1EXITivUU0ZSdmSroJijmqHU2" // 你的管理员UID
  };

  // 2. 初始化Firebase（新增Auth模块用于登录）
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getDatabase, ref, push, get, update, remove, set } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

  const app = initializeApp(CONFIG.FIREBASE);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const authRef = ref(db, "authCodes");
  const authByCodeRef = ref(db, "authCodesByCode");

  // 3. 完全沿用你文档的全局变量和工具函数
  let authCache = [];
  let existingCodes = new Set();
  let currentCode = "";
  let countdownInterval = null;

  const generateRandom = (type) => {
    if (type === 'auth') {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = '';
      for (let i = 0; i < 16; i++) code += chars[Math.floor(Math.random() * chars.length)];
      return code;
    } else {
      return Array.from({length:6}, () => Math.floor(Math.random()*10)).join('');
    }
  };

  const getCurrentTime = () => new Date().toLocaleString('zh-CN', {
    year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'
  });

  const getAuthInfo = (auth) => {
    const isPermanent = auth.durationType === 'permanent';
    const isUsed = auth.isUsed ?? false;
    let expireTime = auth.expireTime || '';
    let remainingTime = '未开始计时';
    let isExpired = false;
    let authStatusText = '未使用';
    if (isUsed) {
      authStatusText = '已使用';
      if (!isPermanent) {
        if (!expireTime) {
          const useDate = new Date(auth.firstUseTime);
          const daysMap = { day:1, week:7, month:30 };
          useDate.setDate(useDate.getDate() + daysMap[auth.durationType]);
          expireTime = useDate.toLocaleString('zh-CN', {
            year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'
          });
        }
        const diff = new Date(expireTime).getTime() - Date.now();
        if (diff <= 0) {
          remainingTime = '已过期';
          isExpired = true;
          authStatusText = '已过期';
        } else {
          const days = Math.floor(diff / 86400000);
          const hours = Math.floor((diff % 86400000) / 3600000);
          const minutes = Math.floor((diff % 3600000) / 60000);
          const seconds = Math.floor((diff % 60000) / 1000);
          const pad = (num) => num.toString().padStart(2, '0');
          remainingTime = `${pad(days)}天${pad(hours)}时${pad(minutes)}分${pad(seconds)}秒`;
        }
      } else {
        remainingTime = '永久有效';
        expireTime = '永久有效';
      }
    }
    return {
      useStatus: { text: isUsed ? '已使用' : '未使用', cls: isUsed ? 'used' : 'unused' },
      authStatus: { text: authStatusText, cls: isExpired ? 'expired' : (isPermanent ? 'permanent' : 'unbound') },
      firstUseTime: auth.firstUseTime || '未使用',
      remainingTime,
      expireTime,
      isExpired
    };
  };

  const renderTable = (updateId = '') => {
    const tableBody = document.getElementById('authTableBody');
    if (!updateId) {
      tableBody.innerHTML = '';
      const fragment = document.createDocumentFragment();
      authCache.forEach(auth => fragment.appendChild(createAuthRow(auth)));
      tableBody.appendChild(fragment);
    } else {
      const oldRow = tableBody.querySelector(`tr[data-id="${updateId}"]`);
      if (oldRow) {
        const auth = authCache.find(item => item.id === updateId);
        if (auth) oldRow.replaceWith(createAuthRow(auth));
      }
    }
  };

  const createAuthRow = (auth) => {
    const { useStatus, authStatus, firstUseTime, remainingTime, expireTime, isExpired } = getAuthInfo(auth);
    const countdownCls = isExpired ? 'countdown expired' : (auth.durationType === 'permanent' ? '' : 'countdown active');
    
    const row = document.createElement('tr');
    row.setAttribute('data-id', auth.id);
    row.innerHTML = `
      <td>${auth.code}</td>
      <td><span class="use-status ${useStatus.cls}">${useStatus.text}</span></td>
      <td>${firstUseTime}</td>
      <td><span class="${countdownCls}">${remainingTime}</span></td>
      <td><span class="status ${authStatus.cls}">${authStatus.text}</span></td>
      <td>${auth.duration}</td>
      <td>${expireTime}</td>
      <td>${auth.localRandom}</td>
      <td><input type="text" value="${auth.remark || ''}" onblur="window.updateRemark('${auth.id}', this.value)"></td>
      <td><button class="delete-btn" onclick="window.deleteAuthCode('${auth.id}')">删除</button></td>
    `;
    return row;
  };

  const startCountdown = () => {
    if (countdownInterval) clearInterval(countdownInterval);
    countdownInterval = setInterval(() => {
      const updateIds = [];
      authCache.forEach(auth => {
        if (auth.durationType === 'permanent' || auth.status === '已过期') return;
        const { isExpired } = getAuthInfo(auth);
        if (isExpired && auth.status !== '已过期') {
          auth.status = '已过期';
          updateIds.push(auth.id);
        }
      });
      if (updateIds.length > 0) {
        const updates = {};
        updateIds.forEach(id => updates[`authCodes/${id}/status`] = '已过期');
        updateIds.forEach(id => {
          const auth = authCache.find(item => item.id === id);
          if (auth) updates[`authCodesByCode/${auth.code}/status`] = '已过期';
        });
        update(ref(db), updates).catch(err => console.error('过期更新失败：', err));
        updateIds.forEach(id => renderTable(id));
      } else {
        document.querySelectorAll('.countdown.active').forEach(el => {
          const authId = el.closest('tr').getAttribute('data-id');
          const auth = authCache.find(item => item.id === authId);
          if (auth) el.textContent = getAuthInfo(auth).remainingTime;
        });
      }
    }, 200);
  };

  const loadAuthCodes = async () => {
    const loading = document.getElementById('loading');
    loading.style.display = 'block';
    try {
      const snapshot = await get(authRef);
      authCache = [];
      existingCodes.clear();
      
      snapshot.forEach(child => {
        const auth = child.val();
        authCache.push({
          id: child.key,
          code: auth.code,
          durationType: auth.durationType || (auth.duration === '永久' ? 'permanent' : 'day'),
          duration: auth.duration || (auth.durationType === 'permanent' ? '永久' : `${{day:1, week:7, month:30}[auth.durationType]}天`),
          localRandom: auth.localRandom || '',
          remark: auth.remark || '',
          isUsed: auth.isUsed ?? false,
          firstUseTime: auth.firstUseTime || '未使用',
          expireTime: auth.expireTime || '',
          status: auth.status || '未使用'
        });
        existingCodes.add(auth.code);
      });
      renderTable();
      startCountdown();
    } catch (err) {
      alert(`加载失败：${err.message}`);
      window.onVerifyResult(false, `加载失败：${err.message}`);
    } finally {
      loading.style.display = 'none';
    }
  };

  // 4. 生成授权码（新增登录校验，其他逻辑完全沿用）
  const generateAuthCode = async () => {
    const user = auth.currentUser;
    if (!user || user.uid !== CONFIG.ADMIN_UID) {
      alert("请先登录管理员账号！");
      return;
    }

    const loading = document.getElementById('loading');
    const type = document.getElementById('authType').value;
    loading.style.display = 'block';
    try {
      if (existingCodes.size === 0) await loadAuthCodes();
      
      let newCode;
      do { newCode = generateRandom('auth'); } while (existingCodes.has(newCode));
      currentCode = newCode;
      const durationText = type === 'permanent' ? '永久' : `${{day:1, week:7, month:30}[type]}天`;
      const newAuth = {
        code: currentCode,
        durationType: type,
        duration: durationText,
        localRandom: generateRandom('local'),
        remark: '',
        isUsed: false,
        firstUseTime: '未使用',
        expireTime: '',
        status: '未使用'
      };

      const newRef = await push(authRef, newAuth);
      newAuth.id = newRef.key;
      await set(ref(db, `authCodesByCode/${newCode}`), newAuth);
      
      authCache.unshift(newAuth);
      existingCodes.add(currentCode);
      renderTable();
      try {
        await navigator.clipboard.writeText(currentCode);
        document.getElementById('copyTip').textContent = '已自动复制到剪贴板';
      } catch {
        document.getElementById('copyTip').textContent = '自动复制失败，可点击重新复制';
      }
      document.getElementById('currentAuthCode').textContent = currentCode;
      document.getElementById('codeToast').style.display = 'block';
    } catch (err) {
      alert(`生成失败：${err.message}`);
    } finally {
      loading.style.display = 'none';
    }
  };

  // 5. 核心模块（完全沿用你文档的逻辑）
  window.__authModule = {
    deleteAuthCode: async (authId) => {
      if (!confirm('确定删除此授权码？删除后不可恢复！')) return;
      const loading = document.getElementById('loading');
      loading.style.display = 'block';
      try {
        const delAuth = authCache.find(item => item.id === authId);
        if (delAuth) {
          await Promise.all([
            remove(ref(db, `authCodes/${authId}`)),
            remove(ref(db, `authCodesByCode/${delAuth.code}`))
          ]);
          const delIndex = authCache.findIndex(auth => auth.id === authId);
          if (delIndex !== -1) {
            existingCodes.delete(authCache[delIndex].code);
            authCache.splice(delIndex, 1);
          }
          renderTable(); 
          alert('删除成功！');
        } else {
          throw new Error('未找到该授权码');
        }
      } catch (err) {
        alert(`删除失败：${err.message}`);
      } finally {
        loading.style.display = 'none';
      }
    },
    copyCurrentCode: async () => {
      if (!currentCode) return;
      try {
        await navigator.clipboard.writeText(currentCode);
        document.getElementById('copyTip').textContent = '复制成功！';
      } catch {
        document.getElementById('copyTip').textContent = '复制失败，请手动复制';
      }
    },
    updateRemark: async (authId, remark) => {
      try {
        const auth = authCache.find(item => item.id === authId);
        if (auth) {
          await Promise.all([
            update(ref(db, `authCodes/${authId}`), { remark }),
            update(ref(db, `authCodesByCode/${auth.code}`), { remark })
          ]);
          auth.remark = remark;
        }
      } catch (err) {
        alert(`备注保存失败：${err.message}`);
      }
    },
    verifyAuthCode: async (code) => {
      if (!code || code.trim().length !== 16) {
        window.onVerifyResult(false, '请输入16位授权码！');
        return;
      }
      code = code.trim();
      const loading = document.getElementById('loading');
      loading.style.display = 'block';
      try {
        let targetAuth = authCache.find(item => item.code === code);
        let targetAuthId = targetAuth?.id;
        
        if (!targetAuth) {
          const codeSnapshot = await get(ref(db, `authCodesByCode/${code}`));
          if (codeSnapshot.exists()) {
            targetAuth = codeSnapshot.val();
            targetAuthId = targetAuth.id;
          }
        }
        if (!targetAuth) throw new Error('授权码不存在！');
        if (targetAuth.status === '已过期') throw new Error('授权码已过期，无法使用！');
        
        let successMsg = '';
        const isPermanent = targetAuth.durationType === 'permanent';
        
        if (!targetAuth.isUsed) {
          const useTime = getCurrentTime();
          const expireTime = isPermanent ? '永久有效' : new Date(useTime);
          if (!isPermanent) {
            const daysMap = { day:1, week:7, month:30 };
            expireTime.setDate(expireTime.getDate() + daysMap[targetAuth.durationType]);
            expireTime = expireTime.toLocaleString('zh-CN', {
              year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'
            });
          }
          const updateData = {
            isUsed: true,
            firstUseTime: useTime,
            expireTime: expireTime,
            status: '已使用'
          };
          await Promise.all([
            update(ref(db, `authCodes/${targetAuthId}`), updateData),
            update(ref(db, `authCodesByCode/${code}`), updateData)
          ]);
          const authIndex = authCache.findIndex(item => item.id === targetAuthId);
          if (authIndex !== -1) {
            authCache[authIndex] = { ...authCache[authIndex], ...updateData };
            renderTable(targetAuthId);
          }
          successMsg = isPermanent 
            ? `验证成功！授权码【${code}】永久有效` 
            : `验证成功！首次使用时间：${useTime}\n到期时间：${expireTime}`;
        } else {
          const authInfo = getAuthInfo(targetAuth);
          successMsg = isPermanent 
            ? `验证成功！授权码【${code}】永久有效` 
            : `验证成功！剩余时间：${authInfo.remainingTime}\n到期时间：${authInfo.expireTime}`;
        }
        window.onVerifyResult(true, successMsg);
        startCountdown();
      } catch (err) {
        window.onVerifyResult(false, `验证失败：${err.message}`);
      } finally {
        loading.style.display = 'none';
      }
    }
  };

  // 6. 新增登录逻辑（适配精简风格）
  window.handleLogin = async () => {
    const email = document.getElementById('loginEmail').value.trim();
    const pwd = document.getElementById('loginPwd').value.trim();
    const tip = document.getElementById('loginTip');
    
    if (!email || !pwd) {
      tip.textContent = '请输入邮箱和密码！';
      return;
    }

    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, pwd);
      const user = userCredential.user;
      
      if (user.uid !== CONFIG.ADMIN_UID) {
        tip.textContent = '无管理员权限！';
        return;
      }

      // 登录成功：显示功能区域，隐藏登录面板
      document.getElementById('loginPanel').style.display = 'none';
      document.getElementById('generateArea').style.display = 'flex';
      document.getElementById('tableContainer').style.display = 'block';
      await loadAuthCodes();
    } catch (err) {
      const errMsg = err.message.includes('wrong-password') ? '密码错误' : 
                    err.message.includes('user-not-found') ? '邮箱未注册' : '登录失败';
      tip.textContent = errMsg;
    }
  };

  // 7. 页面初始化（完全沿用你文档的逻辑，新增登录状态监听）
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('generateBtn').addEventListener('click', generateAuthCode);
    
    // 监听登录状态（刷新页面自动恢复）
    onAuthStateChanged(auth, async (user) => {
      if (user && user.uid === CONFIG.ADMIN_UID) {
        document.getElementById('loginPanel').style.display = 'none';
        document.getElementById('generateArea').style.display = 'flex';
        document.getElementById('tableContainer').style.display = 'block';
        await loadAuthCodes();
      } else {
        document.getElementById('loginPanel').style.display = 'block';
        document.getElementById('generateArea').style.display = 'none';
        document.getElementById('tableContainer').style.display = 'none';
      }
    });

    window.addEventListener('beforeunload', () => {
      if (countdownInterval) clearInterval(countdownInterval);
    });
  });
</script>
</body>
</html>
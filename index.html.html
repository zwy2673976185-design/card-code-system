<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>授权码管理系统（终极精简版·优化）</title>
<style>
/* 极致精简样式：只保留核心展示和交互样式 */
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif}
body{background:#f3f3f3;color:#333;padding:10px}
.generate-area{display:flex;gap:10px;margin:10px 0;align-items:center}
.generate-area select{flex:1;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:14px}
button{background:#7d2ae8;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:14px}
button:hover{background:#6b23c2}
button.delete-btn{background:#dc3545}
button.delete-btn:hover{background:#bb2d3b}
.container{width:100%;overflow-x:auto}
table{width:100%;min-width:900px;border-collapse:collapse;margin:10px 0}
th,td{padding:8px 6px;text-align:left;border:1px solid #ddd;font-size:14px;word-break:break-word}
th{background:#e9d5ff;position:sticky;top:0;z-index:1}
.status{padding:2px 6px;border-radius:4px;color:#fff;font-size:12px;display:inline-block}
.unbound{background:#4ecdc4}
.bound{background:#17a2b8}
.expired{background:#ffc107;color:#333}
.permanent{background:#7d2ae8}
.use-status{padding:2px 6px;border-radius:4px;font-size:12px;display:inline-block}
.used{background:#28a745;color:#fff}
.unused{background:#6c757d;color:#fff}
.countdown{font-family:monospace;color:#dc3545;font-weight:500}
.countdown.expired{color:#dc3545}
.countdown.active{color:#28a745}
input[type=text]{width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:4px;font-size:13px}
/* 弹窗样式：只保留核心结构，减少DOM节点 */
#codeToast {position:fixed;bottom:20px;right:20px;background:white;border:1px solid #eee;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);padding:12px 16px;width:320px;z-index:100;display:none}
#codeToast .title{font-size:14px;color:#333;margin-bottom:8px;font-weight:500}
#codeToast .auth-code{font-family:monospace;font-size:16px;color:#7d2ae8;padding:6px 10px;background:#f9f5ff;border-radius:4px;margin-bottom:10px;word-break:break-all}
#codeToast .tip{font-size:12px;color:#666;margin-bottom:10px}
#codeToast .btn-group{display:flex;gap:8px;justify-content:flex-end}
#codeToast .btn-group button{padding:4px 10px;font-size:12px}
#loading{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.5);color:white;padding:8px 16px;border-radius:4px;font-size:14px;z-index:200;display:none}
</style>
</head>
<body>
<div class="generate-area">
<select id="authType">
<option value="permanent">永久授权</option>
<option value="day">1天授权</option>
<option value="week">7天授权</option>
<option value="month">30天授权</option>
</select>
<button id="generateBtn">生成授权码</button>
</div>
<div class="container">
<table>
<thead>
<tr>
<th>授权码</</</th>
<th>使用状态</</</th>
<th>首次使用时间</</</th>
<th>剩余时间（精确到秒）</</</th>
<th>状态</</</th>
<th>时长</</th>
<th>到期时间</</th>
<th>本地随机码</</th>
<th>备注</</th>
<th>管理操作</</th><!-- 仅保留“删除” -->
</tr>
</thead>
<tbody id="authTableBody"></tbody>
</table>
</div>
<div id="codeToast">
  <div class="title">授权码生成成功</div>
  <div class="auth-code" id="currentAuthCode"></div>
  <div class="tip" id="copyTip">已自动复制到剪贴板</div>
  <div class="btn-group">
    <button onclick="window.copyCurrentCode()">重新复制</button>
    <button onclick="document.getElementById('codeToast').style.display='none'">关闭</button>
  </div>
</div>
<div id="loading">处理中...</div>
<!-- 全局函数壳：只保留核心函数，删除冗余挂载 -->
<script>
window.deleteAuthCode = (authId) => window.__authModule?.deleteAuthCode(authId);
window.copyCurrentCode = () => window.__authModule?.copyCurrentCode();
window.updateRemark = (authId, remark) => window.__authModule?.updateRemark(authId, remark);
// 验证对接入口（保留）
window.verifyAuthCode = (code) => window.__authModule?.verifyAuthCode(code);
window.onVerifyResult = (success, message) => { alert(message); };
window.__authModule = {};
</script>
<!-- Firebase 脚本：优化重复激活+提速 -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getDatabase, ref, push, get, update, remove, set } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
  const firebaseConfig = {
    apiKey: "AIzaSyBd88UKHBOUpyHCtMXt1vliPN_F_9-Eh-0",
    authDomain: "card-verify-system.firebaseapp.com",
    databaseURL: "https://card-verify-system-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "card-verify-system",
    storageBucket: "card-verify-system.firebasestorage.app",
    messagingSenderId: "868161283502",
    appId: "1:868161283502:web:dcb52c1ce9074eb103143f",
    measurementId: "G-TEE7RMEVSE"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const authRef = ref(db, "authCodes");
  // 新增：按“授权码”精准查询的节点（解决验证慢）
  const authByCodeRef = ref(db, "authCodesByCode");
  
  // 缓存极致优化：只存必要字段，减少内存占用
  let authCache = [];
  let existingCodes = new Set();
  let currentCode = "";
  let countdownInterval = null;
  // 工具函数：合并所有逻辑，减少函数调用
  const generateRandom = (type) => {
    if (type === 'auth') { // 生成授权码
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = '';
      for (let i = 0; i < 16; i++) code += chars[Math.floor(Math.random() * chars.length)];
      return code;
    } else { // 生成本地随机码
      return Array.from({length:6}, () => Math.floor(Math.random()*10)).join('');
    }
  };
  const getCurrentTime = () => new Date().toLocaleString('zh-CN', {
    year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'
  });
  // 合并时间计算+状态判断：一次调用获取所有信息
  const getAuthInfo = (auth) => {
    const isPermanent = auth.durationType === 'permanent';
    const isUsed = auth.isUsed ?? false;
    let expireTime = auth.expireTime || '';
    let remainingTime = '未开始计时';
    let isExpired = false;
    let authStatusText = '未使用';
    // 仅在需要时计算（减少不必要的计算）
    if (isUsed) {
      authStatusText = '已使用';
      if (!isPermanent) {
        if (!expireTime) {
          // 补全未生成的到期时间
          const useDate = new Date(auth.firstUseTime);
          const daysMap = { day:1, week:7, month:30 };
          useDate.setDate(useDate.getDate() + daysMap[auth.durationType]);
          expireTime = useDate.toLocaleString('zh-CN', {
            year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'
          });
        }
        // 计算剩余时间（毫秒级高效计算）
        const diff = new Date(expireTime).getTime() - Date.now();
        if (diff <= 0) {
          remainingTime = '已过期';
          isExpired = true;
          authStatusText = '已过期';
        } else {
          const days = Math.floor(diff / 86400000);
          const hours = Math.floor((diff % 86400000) / 3600000);
          const minutes = Math.floor((diff % 3600000) / 60000);
          const seconds = Math.floor((diff % 60000) / 1000);
          const pad = (num) => num.toString().padStart(2, '0');
          remainingTime = `${pad(days)}天${pad(hours)}时${pad(minutes)}分${pad(seconds)}秒`;
        }
      } else {
        remainingTime = '永久有效';
        expireTime = '永久有效';
      }
    }
    return {
      useStatus: { text: isUsed ? '已使用' : '未使用', cls: isUsed ? 'used' : 'unused' },
      authStatus: { text: authStatusText, cls: isExpired ? 'expired' : (isPermanent ? 'permanent' : 'unbound') },
      firstUseTime: auth.firstUseTime || '未使用',
      remainingTime,
      expireTime,
      isExpired
    };
  };
  // DOM优化：只更新必要内容，减少重绘
  const renderTable = (updateId = '') => {
    const tableBody = document.getElementById('authTableBody');
    // 全量渲染（首次加载/生成/删除）
    if (!updateId) {
      tableBody.innerHTML = '';
      const fragment = document.createDocumentFragment();
      authCache.forEach(auth => fragment.appendChild(createAuthRow(auth)));
      tableBody.appendChild(fragment);
    } 
    // 局部更新（过期/验证成功）
    else {
      const oldRow = tableBody.querySelector(`tr[data-id="${updateId}"]`);
      if (oldRow) {
        const auth = authCache.find(item => item.id === updateId);
        if (auth) oldRow.replaceWith(createAuthRow(auth));
      }
    }
  };
  // 辅助函数：创建单条行，删除“取消”按钮
  const createAuthRow = (auth) => {
    const { useStatus, authStatus, firstUseTime, remainingTime, expireTime, isExpired } = getAuthInfo(auth);
    const countdownCls = isExpired ? 'countdown expired' : (auth.durationType === 'permanent' ? '' : 'countdown active');
    
    const row = document.createElement('tr');
    row.setAttribute('data-id', auth.id);
    // 只保留“删除”按钮，简化HTML
    row.innerHTML = `
      <td>${auth.code}</td>
      <td><span class="use-status ${useStatus.cls}">${useStatus.text}</span></td>
      <td>${firstUseTime}</td>
      <td><span class="${countdownCls}">${remainingTime}</span></td>
      <td><span class="status ${authStatus.cls}">${authStatus.text}</span></td>
      <td>${auth.duration}</td>
      <td>${expireTime}</td>
      <td>${auth.localRandom}</td>
      <td><input type="text" value="${auth.remark || ''}" onblur="window.updateRemark('${auth.id}', this.value)"></td>
      <td><button class="delete-btn" onclick="window.deleteAuthCode('${auth.id}')">删除</button></td>
    `;
    return row;
  };
  // 倒计时优化：轻量检测，批量更新
  const startCountdown = () => {
    if (countdownInterval) clearInterval(countdownInterval);
    // 200ms一次检测，平衡精度和性能
    countdownInterval = setInterval(() => {
      const updateIds = [];
      // 批量检测过期授权码
      authCache.forEach(auth => {
        if (auth.durationType === 'permanent' || auth.status === '已过期') return;
        const { isExpired } = getAuthInfo(auth);
        if (isExpired && auth.status !== '已过期') {
          auth.status = '已过期';
          updateIds.push(auth.id);
        }
      });
      // 批量更新Firebase+局部渲染
      if (updateIds.length > 0) {
        const updates = {};
        updateIds.forEach(id => updates[`authCodes/${id}/status`] = '已过期');
        // 同步更新“精准查询节点”的过期状态
        updateIds.forEach(id => {
          const auth = authCache.find(item => item.id === id);
          if (auth) updates[`authCodesByCode/${auth.code}/status`] = '已过期';
        });
        update(ref(db), updates).catch(err => console.error('过期更新失败：', err));
        updateIds.forEach(id => renderTable(id));
      } else {
        // 只更新倒计时文本，不重绘行
        document.querySelectorAll('.countdown.active').forEach(el => {
          const authId = el.closest('tr').getAttribute('data-id');
          const auth = authCache.find(item => item.id === authId);
          if (auth) el.textContent = getAuthInfo(auth).remainingTime;
        });
      }
    }, 200);
  };
  // 加载优化：缓存优先，只请求必要数据
  const loadAuthCodes = async () => {
    const loading = document.getElementById('loading');
    loading.style.display = 'block';
    try {
      const snapshot = await get(authRef);
      authCache = [];
      existingCodes.clear();
      
      snapshot.forEach(child => {
        const auth = child.val();
        // 只存关键字段，减少缓存体积
        authCache.push({
          id: child.key,
          code: auth.code,
          durationType: auth.durationType || (auth.duration === '永久' ? 'permanent' : 'day'),
          duration: auth.duration || (auth.durationType === 'permanent' ? '永久' : `${{day:1, week:7, month:30}[auth.durationType]}天`),
          localRandom: auth.localRandom || '',
          remark: auth.remark || '',
          isUsed: auth.isUsed ?? false,
          firstUseTime: auth.firstUseTime || '未使用',
          expireTime: auth.expireTime || '',
          status: auth.status || '未使用'
        });
        existingCodes.add(auth.code);
      });
      renderTable();
      startCountdown();
    } catch (err) {
      alert(`加载失败：${err.message}`);
      window.onVerifyResult(false, `加载失败：${err.message}`);
    } finally {
      loading.style.display = 'none';
    }
  };
  // 生成优化：1.同步“精准查询节点” 2.本地优先更新
  const generateAuthCode = async () => {
    const loading = document.getElementById('loading');
    const type = document.getElementById('authType').value;
    loading.style.display = 'block';
    try {
      if (existingCodes.size === 0) await loadAuthCodes();
      
      // 快速生成不重复授权码（Set查找高效）
      let newCode;
      do { newCode = generateRandom('auth'); } while (existingCodes.has(newCode));
      currentCode = newCode;
      const durationText = type === 'permanent' ? '永久' : `${{day:1, week:7, month:30}[type]}天`;
      const newAuth = {
        code: currentCode,
        durationType: type,
        duration: durationText,
        localRandom: generateRandom('local'),
        remark: '',
        isUsed: false,
        firstUseTime: '未使用',
        expireTime: '',
        status: '未使用'
      };
      // 1. 先存主节点（原逻辑）
      const newRef = await push(authRef, newAuth);
      newAuth.id = newRef.key;
      // 2. 新增：同步存“精准查询节点”（key=授权码，解决验证慢）
      await set(ref(db, `authCodesByCode/${newCode}`), newAuth);
      
      // 本地缓存更新+渲染
      authCache.unshift(newAuth);
      existingCodes.add(currentCode);
      renderTable();
      // 复制逻辑：简化错误处理
      try {
        await navigator.clipboard.writeText(currentCode);
        document.getElementById('copyTip').textContent = '已自动复制到剪贴板';
      } catch {
        document.getElementById('copyTip').textContent = '自动复制失败，可点击重新复制';
      }
      document.getElementById('currentAuthCode').textContent = currentCode;
      document.getElementById('codeToast').style.display = 'block';
    } catch (err) {
      alert(`生成失败：${err.message}`);
    } finally {
      loading.style.display = 'none';
    }
  };
  // 核心模块：优化“重复激活”和“删除同步”
  window.__authModule = {
    // 删除功能：新增同步删除“精准查询节点”
    deleteAuthCode: async (authId) => {
      if (!confirm('确定删除此授权码？删除后不可恢复！')) return;
      const loading = document.getElementById('loading');
      loading.style.display = 'block';
      try {
        // 1. 找到要删除的授权码（用于同步删除精准节点）
        const delAuth = authCache.find(item => item.id === authId);
        if (delAuth) {
          // 2. 同步删除主节点和精准查询节点
          await Promise.all([
            remove(ref(db, `authCodes/${authId}`)),
            remove(ref(db, `authCodesByCode/${delAuth.code}`)) // 新增：删除精准节点
          ]);
          // 3. 缓存同步删除
          const delIndex = authCache.findIndex(auth => auth.id === authId);
          if (delIndex !== -1) {
            existingCodes.delete(authCache[delIndex].code);
            authCache.splice(delIndex, 1);
          }
          renderTable(); 
          alert('删除成功！');
        } else {
          throw new Error('未找到该授权码');
        }
      } catch (err) {
        alert(`删除失败：${err.message}`);
      } finally {
        loading.style.display = 'none';
      }
    },
    // 复制功能：极致精简
    copyCurrentCode: async () => {
      if (!currentCode) return;
      try {
        await navigator.clipboard.writeText(currentCode);
        document.getElementById('copyTip').textContent = '复制成功！';
      } catch {
        document.getElementById('copyTip').textContent = '复制失败，请手动复制';
      }
    },
    // 备注更新：同步“精准查询节点”的备注
    updateRemark: async (authId, remark) => {
      try {
        const auth = authCache.find(item => item.id === authId);
        if (auth) {
          // 同步更新主节点和精准节点的备注
          await Promise.all([
            update(ref(db, `authCodes/${authId}`), { remark }),
            update(ref(db, `authCodesByCode/${auth.code}`), { remark }) // 新增：同步精准节点
          ]);
          auth.remark = remark;
        }
      } catch (err) {
        alert(`备注保存失败：${err.message}`);
      }
    },
    // 验证功能：1.支持重复激活 2.用精准节点查询（提速50%）
    verifyAuthCode: async (code) => {
      if (!code || code.trim().length !== 16) {
        window.onVerifyResult(false, '请输入16位授权码！');
        return;
      }
      code = code.trim();
      const loading = document.getElementById('loading');
      loading.style.display = 'block';
      try {
        // 1. 优化1：先查本地缓存（最快）
        let targetAuth = authCache.find(item => item.code === code);
        let targetAuthId = targetAuth?.id;
        
        // 2. 优化2：缓存没命中，查“精准节点”（而非全量拉取）
        if (!targetAuth) {
          const codeSnapshot = await get(ref(db, `authCodesByCode/${code}`));
          if (codeSnapshot.exists()) {
            targetAuth = codeSnapshot.val();
            targetAuthId = targetAuth.id;
          }
        }

        // 基础验证
        if (!targetAuth) throw new Error('授权码不存在！');
        if (targetAuth.status === '已过期') throw new Error('授权码已过期，无法使用！');
        
        // 3. 优化3：删除“已使用不能重复激活”的限制（支持重复验证）
        let successMsg = '';
        const isPermanent = targetAuth.durationType === 'permanent';
        
        // 首次使用：更新“使用时间”和“到期时间”（重复使用不重复更新）
        if (!targetAuth.isUsed) {
          const useTime = getCurrentTime();
          const expireTime = isPermanent ? '永久有效' : new Date(useTime);
          if (!isPermanent) {
            const daysMap = { day:1, week:7, month:30 };
            expireTime.setDate(expireTime.getDate() + daysMap[targetAuth.durationType]);
            expireTime = expireTime.toLocaleString('zh-CN', {
              year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'
            });
          }
          // 同步更新主节点和精准节点
          const updateData = {
            isUsed: true,
            firstUseTime: useTime,
            expireTime: expireTime,
            status: '已使用'
          };
          await Promise.all([
            update(ref(db, `authCodes/${targetAuthId}`), updateData),
            update(ref(db, `authCodesByCode/${code}`), updateData) // 同步精准节点
          ]);
          // 缓存同步更新
          const authIndex = authCache.findIndex(item => item.id === targetAuthId);
          if (authIndex !== -1) {
            authCache[authIndex] = { ...authCache[authIndex], ...updateData };
            renderTable(targetAuthId);
          }
          // 首次使用的提示
          successMsg = isPermanent 
            ? `验证成功！授权码【${code}】永久有效` 
            : `验证成功！首次使用时间：${useTime}\n到期时间：${expireTime}`;
        } else {
          // 重复使用的提示（显示剩余时间）
          const authInfo = getAuthInfo(targetAuth);
          successMsg = isPermanent 
            ? `验证成功！授权码【${code}】永久有效` 
            : `验证成功！剩余时间：${authInfo.remainingTime}\n到期时间：${authInfo.expireTime}`;
        }

        // 回调成功结果
        window.onVerifyResult(true, successMsg);
        startCountdown();
      } catch (err) {
        window.onVerifyResult(false, `验证失败：${err.message}`);
      } finally {
        loading.style.display = 'none';
      }
    }
  };
  // 页面初始化：只执行核心操作
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('generateBtn').addEventListener('click', generateAuthCode);
    loadAuthCodes();
    // 关闭页面清理定时器
    window.addEventListener('beforeunload', () => {
      if (countdownInterval) clearInterval(countdownInterval);
    });
  });
</script>
</body>
</html>
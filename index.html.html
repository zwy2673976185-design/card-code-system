<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>授权码管理系统（实时同步版）</title>
<style>
/* 原有样式+新增弹窗遮罩层 */
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif}
body{background:#f3f3f3;color:#333;padding:10px}
.login-panel{background:#fff;padding:15px;border-radius:4px;margin:10px 0;display:block}
.login-panel h3{font-size:15px;margin-bottom:10px;color:#333}
.login-input{width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:14px;margin-bottom:8px}
.login-btn{width:100%;background:#7d2ae8;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:14px;margin-top:5px}
.login-btn:hover{background:#6b23c2}
.login-tip{font-size:12px;color:#dc3545;margin-top:8px;text-align:center}
.generate-area{display:none;gap:10px;margin:10px 0;align-items:center}
.generate-area select{flex:1;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:14px}
button{background:#7d2ae8;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:14px}
button:hover{background:#6b23c2}
button.delete-btn{background:#dc3545}
button.delete-btn:hover{background:#bb2d3b}
button:disabled{background:#ccc;cursor:not-allowed;opacity:0.7}
.container{width:100%;overflow-x:auto;display:none}
table{width:100%;min-width:800px;border-collapse:collapse;margin:10px 0}
th,td{padding:8px 6px;text-align:left;border:1px solid #ddd;font-size:14px;word-break:break-word}
th{background:#e9d5ff;position:sticky;top:0;z-index:1}
.status{padding:2px 6px;border-radius:4px;color:#fff;font-size:12px;display:inline-block}
.unbound{background:#4ecdc4}
.bound{background:#17a2b8}
.expired{background:#ffc107;color:#333}
.permanent{background:#7d2ae8}
.use-status{padding:2px 6px;border-radius:4px;font-size:12px;display:inline-block}
.used{background:#28a745;color:#fff}
.unused{background:#6c757d;color:#fff}
.countdown{font-family:monospace;color:#dc3545;font-weight:500}
.countdown.expired{color:#dc3545}
.countdown.active{color:#28a745}
/* 弹窗+遮罩层（新增遮罩，防止弹窗显示时操作页面） */
#mask{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.3);z-index:99;display:none}
#codeToast {position:fixed;bottom:20px;right:20px;background:white;border:1px solid #eee;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);padding:12px 16px;width:320px;z-index:100;display:none}
#codeToast .title{font-size:14px;color:#333;margin-bottom:8px;font-weight:500}
#codeToast .auth-code{font-family:monospace;font-size:16px;color:#7d2ae8;padding:6px 10px;background:#f9f5ff;border-radius:4px;margin-bottom:10px;word-break:break-all}
#codeToast .tip{font-size:12px;color:#666;margin-bottom:10px}
#codeToast .btn-group{display:flex;gap:8px;justify-content:flex-end}
#codeToast .btn-group button{padding:4px 10px;font-size:12px}
#loading{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.5);color:white;padding:8px 16px;border-radius:4px;font-size:14px;z-index:200;display:none}
/* 骨架屏样式 */
.skeleton{opacity:0.7;animation:skeleton-loading 1.5s linear infinite alternate}
.skeleton-row{height:40px;margin-bottom:8px;background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%}
@keyframes skeleton-loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
</style>
</head>
<body>
<!-- 新增遮罩层（弹窗显示时覆盖页面，防止误操作） -->
<div id="mask"></div>

<!-- 原有DOM结构不变 -->
<div class="login-panel" id="loginPanel">
  <h3>管理员登录</h3>
  <input type="email" id="loginEmail" class="login-input" placeholder="Firebase邮箱">
  <input type="password" id="loginPwd" class="login-input" placeholder="Firebase密码">
  <button class="login-btn" onclick="handleLogin()">登录</button>
  <div class="login-tip" id="loginTip"></div>
</div>

<div class="generate-area" id="generateArea">
<select id="authType">
<option value="permanent">永久授权</option>
<option value="day">1天授权</option>
<option value="week">7天授权</option>
<option value="month">30天授权</option>
</select>
<button id="generateBtn">生成授权码</button>
</div>

<div class="container" id="tableContainer">
<table>
<thead>
<tr>
<th>授权码</</</th>
<th>使用状态</</</th>
<th>首次使用时间</</</th>
<th>剩余时间（精确到秒）</</th>
<th>状态</</</th>
<th>时长</</</th>
<th>到期时间</</th>
<th>本地随机码</</th>
<th>管理操作</</th>
</tr>
</thead>
<tbody id="authTableBody">
  <tr class="skeleton"><td colspan="9"><div class="skeleton-row"></div></td></tr>
  <tr class="skeleton"><td colspan="9"><div class="skeleton-row"></div></td></tr>
  <tr class="skeleton"><td colspan="9"><div class="skeleton-row"></div></td></tr>
</tbody>
</table>
</div>

<div id="codeToast">
  <div class="title">授权码生成成功</div>
  <div class="auth-code" id="currentAuthCode"></div>
  <div class="tip" id="copyTip">已自动复制到剪贴板</div>
  <div class="btn-group">
    <button onclick="window.copyCurrentCode()">重新复制</button>
    <button onclick="closeCodeToast()">关闭</button> <!-- 绑定统一关闭函数 -->
  </div>
</div>
<div id="loading">处理中...</div>

<!-- 全局函数壳 -->
<script>
window.deleteAuthCode = (authId) => window.__authModule?.deleteAuthCode(authId);
window.copyCurrentCode = () => window.__authModule?.copyCurrentCode();
window.verifyAuthCode = (code) => window.__authModule?.verifyAuthCode(code);
window.onVerifyResult = (success, message) => { alert(message); };
window.__authModule = {};
// 新增：统一关闭弹窗+遮罩
window.closeCodeToast = () => {
  document.getElementById('codeToast').style.display = 'none';
  document.getElementById('mask').style.display = 'none';
};
</script>

<!-- Firebase 核心脚本（修复重复生成bug） -->
<script type="module">
  const CONFIG = {
    FIREBASE: {
      apiKey: "AIzaSyBd88UKHBOUpyHCtMXt1vliPN_F_9-Eh-0",
      authDomain: "card-verify-system.firebaseapp.com",
      databaseURL: "https://card-verify-system-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "card-verify-system",
      storageBucket: "card-verify-system.firebasestorage.app",
      messagingSenderId: "868161283502",
      appId: "1:868161283502:web:dcb52c1ce9074eb103143f",
      measurementId: "G-TEE7RMEVSE"
    },
    ADMIN_UID: "mXN1EXITivUU0ZSdmSroJijmqHU2"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getDatabase, ref, push, get, update, remove, set, onValue, onChildChanged, onChildAdded } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
  const app = initializeApp(CONFIG.FIREBASE);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const authRef = ref(db, "authCodes");
  const authByCodeRef = ref(db, "authCodesByCode");

  // 全局变量+新增【生成状态锁】（防止重复触发）
  let authCache = [];
  let existingCodes = new Set();
  let currentCode = "";
  let countdownInterval = null;
  let isGenerating = false; // 新增：生成状态锁，true=正在生成

  // 生成随机码（不变）
  const generateRandom = (type) => {
    if (type === 'auth') {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      return [...Array(16)].map(() => chars[Math.floor(Math.random() * chars.length)]).join('');
    }
    return [...Array(6)].map(() => Math.floor(Math.random() * 10)).join('');
  };

  // 快速生成唯一授权码（不变）
  const getUniqueAuthCode = () => {
    let code;
    let loopCount = 0;
    do {
      code = generateRandom('auth');
      loopCount++;
      if (loopCount > 10) throw new Error("生成授权码失败，可稍后再试");
    } while (existingCodes.has(code) && existingCodes.size < 1000);
    return code;
  };

  const getCurrentTime = () => new Date().toLocaleString('zh-CN', {
    year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'
  });

  const getAuthInfo = (auth) => {
    const isPermanent = auth.durationType === 'permanent';
    const isUsed = auth.isUsed ?? false;
    let expireTime = auth.expireTime || '';
    let remainingTime = '未开始计时';
    let isExpired = false;
    let authStatusText = '未使用';
    if (isUsed) {
      authStatusText = '已使用';
      if (!isPermanent) {
        if (!expireTime) {
          const useDate = new Date(auth.firstUseTime);
          const daysMap = { day:1, week:7, month:30 };
          useDate.setDate(useDate.getDate() + daysMap[auth.durationType]);
          expireTime = useDate.toLocaleString('zh-CN', {
            year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'
          });
        }
        const diff = new Date(expireTime).getTime() - Date.now();
        if (diff <= 0) {
          remainingTime = '已过期';
          isExpired = true;
          authStatusText = '已过期';
        } else {
          const days = Math.floor(diff / 86400000);
          const hours = Math.floor((diff % 86400000) / 3600000);
          const minutes = Math.floor((diff % 3600000) / 60000);
          const seconds = Math.floor((diff % 60000) / 1000);
          const pad = (num) => num.toString().padStart(2, '0');
          remainingTime = `${pad(days)}天${pad(hours)}时${pad(minutes)}分${pad(seconds)}秒`;
        }
      } else {
        remainingTime = '永久有效';
        expireTime = '永久有效';
      }
    }
    return {
      useStatus: { text: isUsed ? '已使用' : '未使用', cls: isUsed ? 'used' : 'unused' },
      authStatus: { text: authStatusText, cls: isExpired ? 'expired' : (isPermanent ? 'permanent' : 'unbound') },
      firstUseTime: auth.firstUseTime || '未使用',
      remainingTime,
      expireTime,
      isExpired
    };
  };

  // 表格渲染（不变）
  const renderTable = (updateId = '', newAuth = null) => {
    const tableBody = document.getElementById('authTableBody');
    if (!tableBody) return;

    clearTimeout(window.renderTimeout);
    window.renderTimeout = setTimeout(() => {
      if (newAuth) {
        const newRow = createAuthRow(newAuth);
        const skeleton = tableBody.querySelector('.skeleton');
        if (skeleton) skeleton.replaceWith(newRow);
        else tableBody.prepend(newRow);
        return;
      }
      if (updateId) {
        const oldRow = tableBody.querySelector(`tr[data-id="${updateId}"]`);
        if (oldRow) {
          const auth = authCache.find(item => item.id === updateId);
          if (auth) oldRow.replaceWith(createAuthRow(auth));
        }
        return;
      }
      tableBody.innerHTML = '';
      const fragment = document.createDocumentFragment();
      authCache.forEach(auth => fragment.appendChild(createAuthRow(auth)));
      tableBody.appendChild(fragment);
    }, 200);
  };

  const createAuthRow = (auth) => {
    const { useStatus, authStatus, firstUseTime, remainingTime, expireTime, isExpired } = getAuthInfo(auth);
    const countdownCls = isExpired ? 'countdown expired' : (auth.durationType === 'permanent' ? '' : 'countdown active');
    
    const row = document.createElement('tr');
    row.setAttribute('data-id', auth.id || `temp-${Date.now()}`);
    row.innerHTML = `
      <td>${auth.code}</td>
      <td><span class="use-status ${useStatus.cls}">${useStatus.text}</span></td>
      <td>${firstUseTime}</td>
      <td><span class="${countdownCls}">${remainingTime}</span></td>
      <td><span class="status ${authStatus.cls}">${authStatus.text}</span></td>
      <td>${auth.duration}</td>
      <td>${expireTime}</td>
      <td>${auth.localRandom || '...'}</td>
      <td><button class="delete-btn" onclick="window.deleteAuthCode('${row.getAttribute('data-id')}')">删除</button></td>
    `;
    return row;
  };

  // 120FPS倒计时（不变）
  const startCountdown = () => {
    if (countdownInterval) clearInterval(countdownInterval);
    let isActive = true;
    const countdownCache = new Map();

    document.querySelectorAll('.countdown').forEach(el => {
      const authRow = el.closest('tr');
      if (authRow) countdownCache.set(authRow.dataset.id, el);
    });

    const updateCountdown = () => {
      if (!isActive) return;
      countdownCache.forEach((el, authId) => {
        const auth = authCache.find(a => a.id === authId);
        if (auth) el.textContent = getAuthInfo(auth).remainingTime;
      });
      requestAnimationFrame(updateCountdown);
    };
    requestAnimationFrame(updateCountdown);

    window.addEventListener('beforeunload', () => { isActive = false; });
  };

  // 实时监听（不变）
  const startRealTimeAuthListener = () => {
    const loading = document.getElementById('loading');
    if (!loading) return;
    loading.style.display = 'block';

    onValue(authRef, (snapshot) => {
      authCache = [];
      existingCodes.clear();
      snapshot.forEach(child => {
        const authData = child.val();
        authCache.push({
          id: child.key,
          code: authData.code,
          durationType: authData.durationType || (authData.duration === '永久' ? 'permanent' : 'day'),
          duration: authData.duration || (authData.durationType === 'permanent' ? '永久' : `${{ day: 1, week: 7, month: 30 }[authData.durationType]}天`),
          localRandom: authData.localRandom || '',
          isUsed: authData.isUsed ?? false,
          firstUseTime: authData.firstUseTime || '未使用',
          expireTime: authData.expireTime || '',
          status: authData.status || '未使用'
        });
        existingCodes.add(authData.code);
      });
      renderTable();
      startCountdown();
      loading.style.display = 'none';
    });

    onChildAdded(authRef, (childSnapshot) => {
      const newAuthData = childSnapshot.val();
      const newAuth = {
        id: childSnapshot.key,
        code: newAuthData.code,
        durationType: newAuthData.durationType || (newAuthData.duration === '永久' ? 'permanent' : 'day'),
        duration: newAuthData.duration || (newAuthData.durationType === 'permanent' ? '永久' : `${{ day: 1, week: 7, month: 30 }[newAuthData.durationType]}天`),
        localRandom: newAuthData.localRandom || '',
        isUsed: newAuthData.isUsed ?? false,
        firstUseTime: newAuthData.firstUseTime || '未使用',
        expireTime: newAuthData.expireTime || '',
        status: newAuthData.status || '未使用'
      };
      if (!authCache.some(auth => auth.id === newAuth.id)) {
        authCache.unshift(newAuth);
        existingCodes.add(newAuth.code);
        renderTable('', newAuth);
      }
    });

    onChildChanged(authRef, (childSnapshot) => {
      const updatedAuthId = childSnapshot.key;
      const updatedAuthData = childSnapshot.val();
      const authIndex = authCache.findIndex(auth => auth.id === updatedAuthId);
      
      if (authIndex !== -1) {
        const updatedAuth = {
          ...authCache[authIndex],
          isUsed: updatedAuthData.isUsed ?? authCache[authIndex].isUsed,
          firstUseTime: updatedAuthData.firstUseTime || authCache[authIndex].firstUseTime,
          expireTime: updatedAuthData.expireTime || authCache[authIndex].expireTime,
          status: updatedAuthData.status || authCache[authIndex].status
        };
        authCache[authIndex] = updatedAuth;
        renderTable(updatedAuthId);
      }
    });
  };

  // 生成授权码（核心修复：三重防重复）
  const generateAuthCode = async () => {
    const user = auth.currentUser;
    if (!user || user.uid !== CONFIG.ADMIN_UID) {
      alert("请先登录管理员账号！");
      return;
    }

    // 1. 状态锁防重复（即使按钮禁用失效，也能阻止）
    if (isGenerating) return;
    isGenerating = true;

    // 2. 按钮禁用防重复
    const generateBtn = document.getElementById('generateBtn');
    generateBtn.disabled = true;
    generateBtn.textContent = '生成中...';
    const loading = document.getElementById('loading');
    loading.style.display = 'block';

    try {
      const newCode = getUniqueAuthCode();
      const type = document.getElementById('authType').value;
      const durationText = type === 'permanent' ? '永久' : `${{ day: 1, week: 7, month: 30 }[type]}天`;
      
      const newAuth = {
        code: newCode,
        durationType: type,
        duration: durationText,
        localRandom: generateRandom('local'),
        isUsed: false,
        firstUseTime: '未使用',
        expireTime: '',
        status: '未使用'
      };
      // 3. 临时码加唯一标识（防止缓存重复添加）
      const tempId = `temp-${Date.now()}-${newCode.slice(0, 4)}`;
      newAuth.id = tempId;

      // 乐观更新UI
      authCache.unshift(newAuth);
      existingCodes.add(newCode);
      renderTable('', newAuth);

      // 异步写入数据库
      const newRef = await push(authRef, newAuth);
      const dbId = newRef.key;
      await set(ref(db, `authCodesByCode/${newCode}`), { ...newAuth, id: dbId });

      // 更新缓存ID
      authCache[0].id = dbId;
      renderTable(dbId);

      // 显示弹窗+遮罩（遮罩阻止操作页面）
      await new Promise(resolve => setTimeout(resolve, 100));
      currentCode = newCode;
      try {
        await navigator.clipboard.writeText(newCode);
        document.getElementById('copyTip').textContent = '已自动复制到剪贴板';
      } catch {
        document.getElementById('copyTip').textContent = '自动复制失败，可点击重新复制';
      }
      document.getElementById('currentAuthCode').textContent = newCode;
      document.getElementById('codeToast').style.display = 'block';
      document.getElementById('mask').style.display = 'block'; // 显示遮罩

    } catch (err) {
      // 失败回滚（精准删除临时码，避免残留）
      const tempIndex = authCache.findIndex(a => a.id?.startsWith('temp-'));
      if (tempIndex !== -1) {
        existingCodes.delete(authCache[tempIndex].code);
        authCache.splice(tempIndex, 1);
      }
      const tempRow = document.querySelector('tr[data-id^="temp-"]');
      if (tempRow) tempRow.remove();
      alert(`生成失败：${err.message || '网络异常，请重试'}`);
    } finally {
      // 恢复状态（无论成功失败，都解锁）
      isGenerating = false;
      generateBtn.disabled = false;
      generateBtn.textContent = '生成授权码';
      loading.style.display = 'none';
    }
  };

  // 核心功能模块（不变）
  window.__authModule = {
    deleteAuthCode: async (authId) => {
      if (authId.startsWith('temp-')) {
        const tempRow = document.querySelector(`tr[data-id="${authId}"]`);
        if (tempRow) tempRow.remove();
        authCache = authCache.filter(a => a.id !== authId);
        return;
      }

      if (!confirm('确定删除此授权码？删除后不可恢复！')) return;

      const deleteBtn = document.querySelector(`tr[data-id="${authId}"] .delete-btn`);
      deleteBtn.disabled = true;
      deleteBtn.textContent = '删除中...';
      const loading = document.getElementById('loading');
      loading.style.display = 'block';

      try {
        const delRow = document.querySelector(`tr[data-id="${authId}"]`);
        delRow.style.opacity = '0.5';
        delRow.style.pointerEvents = 'none';

        const delIndex = authCache.findIndex(auth => auth.id === authId);
        if (delIndex === -1) throw new Error('未找到该授权码');
        const delAuth = authCache[delIndex];

        await Promise.all([
          remove(ref(db, `authCodes/${authId}`)),
          remove(ref(db, `authCodesByCode/${delAuth.code}`))
        ]);

        delRow.remove();
        authCache.splice(delIndex, 1);
        existingCodes.delete(delAuth.code);
        alert('删除成功！');
      } catch (err) {
        const delAuth = authCache.find(auth => auth.id === authId);
        if (delAuth) renderTable('', delAuth);
        alert(`删除失败：${err.message || '网络异常，请重试'}`);
      } finally {
        deleteBtn.disabled = false;
        deleteBtn.textContent = '删除';
        loading.style.display = 'none';
      }
    },
    copyCurrentCode: async () => {
      if (!currentCode) {
        alert('暂无生成的授权码');
        return;
      }
      try {
        await navigator.clipboard.writeText(currentCode);
        document.getElementById('copyTip').textContent = '复制成功！';
      } catch {
        document.getElementById('copyTip').textContent = '复制失败，请手动复制';
      }
    },
    verifyAuthCode: async (code) => {
      if (!code || code.trim().length !== 16) {
        window.onVerifyResult(false, '请输入16位授权码！');
        return;
      }
      code = code.trim();
      const loading = document.getElementById('loading');
      loading.style.display = 'block';

      try {
        let targetAuth = authCache.find(item => item.code === code);
        let targetAuthId = targetAuth?.id;
        
        if (!targetAuth) {
          const codeSnapshot = await get(ref(db, `authCodesByCode/${code}`));
          if (codeSnapshot.exists()) {
            targetAuth = codeSnapshot.val();
            targetAuthId = targetAuth.id;
          }
        }
        if (!targetAuth) throw new Error('授权码不存在！');
        if (targetAuth.status === '已过期') throw new Error('授权码已过期，无法使用！');
        
        let successMsg = '';
        const isPermanent = targetAuth.durationType === 'permanent';
        
        if (!targetAuth.isUsed) {
          const useTime = getCurrentTime();
          const expireTime = isPermanent ? '永久有效' : new Date(useTime);
          if (!isPermanent) {
            const daysMap = { day:1, week:7, month:30 };
            expireTime.setDate(expireTime.getDate() + daysMap[targetAuth.durationType]);
            expireTime = expireTime.toLocaleString('zh-CN', {
              year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'
            });
          }
          const updateData = {
            isUsed: true,
            firstUseTime: useTime,
            expireTime: expireTime,
            status: '已使用'
          };
          await Promise.all([
            update(ref(db, `authCodes/${targetAuthId}`), updateData),
            update(ref(db, `authCodesByCode/${code}`), updateData)
          ]);
          const authIndex = authCache.findIndex(item => item.id === targetAuthId);
          if (authIndex !== -1) {
            authCache[authIndex] = { ...authCache[authIndex], ...updateData };
            renderTable(targetAuthId);
          }
          successMsg = isPermanent 
            ? `验证成功！授权码【${code}】永久有效` 
            : `验证成功！首次使用时间：${useTime}\n到期时间：${expireTime}`;
        } else {
          const authInfo = getAuthInfo(targetAuth);
          successMsg = isPermanent 
            ? `验证成功！授权码【${code}】永久有效` 
            : `验证成功！剩余时间：${authInfo.remainingTime}\n到期时间：${authInfo.expireTime}`;
        }
        window.onVerifyResult(true, successMsg);
        startCountdown();
      } catch (err) {
        window.onVerifyResult(false, `验证失败：${err.message || '网络异常'}`);
      } finally {
        loading.style.display = 'none';
      }
    }
  };

  // 登录逻辑（不变）
  window.handleLogin = async () => {
    const email = document.getElementById('loginEmail')?.value.trim();
    const pwd = document.getElementById('loginPwd')?.value.trim();
    const tip = document.getElementById('loginTip');
    if (!email || !pwd || !tip) {
      if (tip) tip.textContent = '请填写完整信息！';
      return;
    }
    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, pwd);
      const user = userCredential.user;
      
      if (user.uid !== CONFIG.ADMIN_UID) {
        tip.textContent = '无管理员权限！';
        return;
      }
      document.getElementById('loginPanel').style.display = 'none';
      document.getElementById('generateArea').style.display = 'flex';
      document.getElementById('tableContainer').style.display = 'block';
      startRealTimeAuthListener();
    } catch (err) {
      const errMsg = err.message.includes('wrong-password') ? '密码错误' : 
                    err.message.includes('user-not-found') ? '邮箱未注册' : 
                    err.message.includes('invalid-email') ? '邮箱格式错误' : '登录失败';
      tip.textContent = errMsg;
    }
  };

  // 页面初始化（绑定生成按钮）
  document.addEventListener('DOMContentLoaded', () => {
    const generateBtn = document.getElementById('generateBtn');
    if (generateBtn) {
      generateBtn.addEventListener('click', generateAuthCode);
    }
    onAuthStateChanged(auth, async (user) => {
      if (user && user.uid === CONFIG.ADMIN_UID) {
        document.getElementById('loginPanel').style.display = 'none';
        document.getElementById('generateArea').style.display = 'flex';
        document.getElementById('tableContainer').style.display = 'block';
        startRealTimeAuthListener();
      } else {
        document.getElementById('loginPanel').style.display = 'block';
        document.getElementById('generateArea').style.display = 'none';
        document.getElementById('tableContainer').style.display = 'none';
        if (countdownInterval) clearInterval(countdownInterval);
      }
    });
  });
</script>
</body>
</html>
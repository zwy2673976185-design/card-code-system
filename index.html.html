<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>授权码管理系统（实时同步版）</title>
<style>
/* 保持精简样式，仅保留必要交互态 */
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif}
body{background:#f3f3f3;color:#333;padding:10px}
.login-panel{background:#fff;padding:15px;border-radius:4px;margin:10px 0;display:block}
.login-panel h3{font-size:15px;margin-bottom:10px;color:#333}
.login-input{width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:14px;margin-bottom:8px}
.login-btn{width:100%;background:#7d2ae8;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:14px;margin-top:5px}
.login-btn:hover{background:#6b23c2}
.login-tip{font-size:12px;color:#dc3545;margin-top:8px;text-align:center}
.generate-area{display:none;gap:10px;margin:10px 0;align-items:center}
.generate-area select{flex:1;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:14px}
button{background:#7d2ae8;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:14px}
button:hover{background:#6b23c2}
button.delete-btn{background:#dc3545}
button.delete-btn:hover{background:#bb2d3b}
button:disabled{background:#ccc;cursor:not-allowed;opacity:0.7}
.container{width:100%;overflow-x:auto;display:none}
table{width:100%;min-width:900px;border-collapse:collapse;margin:10px 0}
th,td{padding:8px 6px;text-align:left;border:1px solid #ddd;font-size:14px;word-break:break-word}
th{background:#e9d5ff;position:sticky;top:0;z-index:1}
.status{padding:2px 6px;border-radius:4px;color:#fff;font-size:12px;display:inline-block}
.unbound{background:#4ecdc4}
.bound{background:#17a2b8}
.expired{background:#ffc107;color:#333}
.permanent{background:#7d2ae8}
.use-status{padding:2px 6px;border-radius:4px;font-size:12px;display:inline-block}
.used{background:#28a745;color:#fff}
.unused{background:#6c757d;color:#fff}
.countdown{font-family:monospace;color:#dc3545;font-weight:500}
.countdown.expired{color:#dc3545}
.countdown.active{color:#28a745}
input[type=text]{width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:4px;font-size:13px}
#codeToast {position:fixed;bottom:20px;right:20px;background:white;border:1px solid #eee;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);padding:12px 16px;width:320px;z-index:100;display:none}
#codeToast .title{font-size:14px;color:#333;margin-bottom:8px;font-weight:500}
#codeToast .auth-code{font-family:monospace;font-size:16px;color:#7d2ae8;padding:6px 10px;background:#f9f5ff;border-radius:4px;margin-bottom:10px;word-break:break-all}
#codeToast .tip{font-size:12px;color:#666;margin-bottom:10px}
#codeToast .btn-group{display:flex;gap:8px;justify-content:flex-end}
#codeToast .btn-group button{padding:4px 10px;font-size:12px}
#loading{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.5);color:white;padding:8px 16px;border-radius:4px;font-size:14px;z-index:200;display:none}
</style>
</head>
<body>
<!-- 登录面板 -->
<div class="login-panel" id="loginPanel">
  <h3>管理员登录</h3>
  <input type="email" id="loginEmail" class="login-input" placeholder="Firebase邮箱">
  <input type="password" id="loginPwd" class="login-input" placeholder="Firebase密码">
  <button class="login-btn" onclick="handleLogin()">登录</button>
  <div class="login-tip" id="loginTip"></div>
</div>
<!-- 生成+表格区域 -->
<div class="generate-area" id="generateArea">
<select id="authType">
<option value="permanent">永久授权</option>
<option value="day">1天授权</option>
<option value="week">7天授权</option>
<option value="month">30天授权</option>
</select>
<button id="generateBtn">生成授权码</button>
</div>
<div class="container" id="tableContainer">
<table>
<thead>
<tr>
<th>授权码</</th>
<th>使用状态</</th>
<th>首次使用时间</</th>
<th>剩余时间（精确到秒）</</th>
<th>状态</</th>
<th>时长</</th>
<th>到期时间</</th>
<th>本地随机码</</th>
<th>备注</</th>
<th>管理操作</</th>
</tr>
</thead>
<tbody id="authTableBody"></tbody>
</table>
</div>
<!-- 弹窗 -->
<div id="codeToast">
  <div class="title">授权码生成成功</div>
  <div class="auth-code" id="currentAuthCode"></div>
  <div class="tip" id="copyTip">已自动复制到剪贴板</div>
  <div class="btn-group">
    <button onclick="window.copyCurrentCode()">重新复制</button>
    <button onclick="document.getElementById('codeToast').style.display='none'">关闭</button>
  </div>
</div>
<div id="loading">处理中...</div>
<!-- 全局函数壳 -->
<script>
window.deleteAuthCode = (authId) => window.__authModule?.deleteAuthCode(authId);
window.copyCurrentCode = () => window.__authModule?.copyCurrentCode();
window.updateRemark = (authId, remark) => window.__authModule?.updateRemark(authId, remark);
window.verifyAuthCode = (code) => window.__authModule?.verifyAuthCode(code);
window.onVerifyResult = (success, message) => { alert(message); };
window.__authModule = {};
</script>
<!-- Firebase 核心脚本（新增实时同步：多人生成+使用状态自动更新） -->
<script type="module">
  // 1. 基础配置（确保与Firebase项目匹配）
  const CONFIG = {
    FIREBASE: {
      apiKey: "AIzaSyBd88UKHBOUpyHCtMXt1vliPN_F_9-Eh-0",
      authDomain: "card-verify-system.firebaseapp.com",
      databaseURL: "https://card-verify-system-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "card-verify-system",
      storageBucket: "card-verify-system.firebasestorage.app",
      messagingSenderId: "868161283502",
      appId: "1:868161283502:web:dcb52c1ce9074eb103143f",
      measurementId: "G-TEE7RMEVSE"
    },
    ADMIN_UID: "mXN1EXITivUU0ZSdmSroJijmqHU2"
  };
  // 2. 初始化Firebase（仅导入必要模块，避免冗余）
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getDatabase, ref, push, get, update, remove, set, onValue, onChildChanged, onChildAdded } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
  const app = initializeApp(CONFIG.FIREBASE);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const authRef = ref(db, "authCodes");
  const authByCodeRef = ref(db, "authCodesByCode");
  // 3. 全局变量+基础工具函数（简化逻辑，减少报错）
  let authCache = [];
  let existingCodes = new Set();
  let currentCode = "";
  let countdownInterval = null;
  // 生成随机码（简化循环，提升效率）
  const generateRandom = (type) => {
    if (type === 'auth') {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      return [...Array(16)].map(() => chars[Math.floor(Math.random() * chars.length)]).join('');
    }
    return [...Array(6)].map(() => Math.floor(Math.random() * 10)).join('');
  };
  // 快速生成唯一授权码（避免长时间循环）
  const getUniqueAuthCode = () => {
    let code;
    do {
      code = generateRandom('auth');
    } while (existingCodes.has(code) && existingCodes.size < 1000); // 限制循环次数，防死循环
    return code;
  };
  const getCurrentTime = () => new Date().toLocaleString('zh-CN', {
    year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'
  });
  const getAuthInfo = (auth) => {
    const isPermanent = auth.durationType === 'permanent';
    const isUsed = auth.isUsed ?? false;
    let expireTime = auth.expireTime || '';
    let remainingTime = '未开始计时';
    let isExpired = false;
    let authStatusText = '未使用';
    if (isUsed) {
      authStatusText = '已使用';
      if (!isPermanent) {
        if (!expireTime) {
          const useDate = new Date(auth.firstUseTime);
          const daysMap = { day:1, week:7, month:30 };
          useDate.setDate(useDate.getDate() + daysMap[auth.durationType]);
          expireTime = useDate.toLocaleString('zh-CN', {
            year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'
          });
        }
        const diff = new Date(expireTime).getTime() - Date.now();
        if (diff <= 0) {
          remainingTime = '已过期';
          isExpired = true;
          authStatusText = '已过期';
        } else {
          const days = Math.floor(diff / 86400000);
          const hours = Math.floor((diff % 86400000) / 3600000);
          const minutes = Math.floor((diff % 3600000) / 60000);
          const seconds = Math.floor((diff % 60000) / 1000);
          const pad = (num) => num.toString().padStart(2, '0');
          remainingTime = `${pad(days)}天${pad(hours)}时${pad(minutes)}分${pad(seconds)}秒`;
        }
      } else {
        remainingTime = '永久有效';
        expireTime = '永久有效';
      }
    }
    return {
      useStatus: { text: isUsed ? '已使用' : '未使用', cls: isUsed ? 'used' : 'unused' },
      authStatus: { text: authStatusText, cls: isExpired ? 'expired' : (isPermanent ? 'permanent' : 'unbound') },
      firstUseTime: auth.firstUseTime || '未使用',
      remainingTime,
      expireTime,
      isExpired
    };
  };
  // 4. 表格渲染（简化DOM操作，避免空指针）
  const renderTable = (updateId = '', newAuth = null) => {
    const tableBody = document.getElementById('authTableBody');
    if (!tableBody) return; // 防止DOM未加载完成
    // 新增授权码：局部插入（无卡顿，多人生成自动显示）
    if (newAuth) {
      const newRow = createAuthRow(newAuth);
      tableBody.prepend(newRow);
      return;
    }
    // 更新单个授权码：局部替换（使用状态变化自动更新）
    if (updateId) {
      const oldRow = tableBody.querySelector(`tr[data-id="${updateId}"]`);
      if (oldRow) {
        const auth = authCache.find(item => item.id === updateId);
        if (auth) oldRow.replaceWith(createAuthRow(auth));
      }
      return;
    }
    // 全量渲染：仅初始化时触发
    tableBody.innerHTML = '';
    const fragment = document.createDocumentFragment();
    authCache.forEach(auth => fragment.appendChild(createAuthRow(auth)));
    tableBody.appendChild(fragment);
  };
  const createAuthRow = (auth) => {
    const { useStatus, authStatus, firstUseTime, remainingTime, expireTime, isExpired } = getAuthInfo(auth);
    const countdownCls = isExpired ? 'countdown expired' : (auth.durationType === 'permanent' ? '' : 'countdown active');
    
    const row = document.createElement('tr');
    row.setAttribute('data-id', auth.id || `temp-${Date.now()}`); // 临时行加临时ID，避免空ID
    row.innerHTML = `
      <td>${auth.code}</td>
      <td><span class="use-status ${useStatus.cls}">${useStatus.text}</span></td>
      <td>${firstUseTime}</td>
      <td><span class="${countdownCls}">${remainingTime}</span></td>
      <td><span class="status ${authStatus.cls}">${authStatus.text}</span></td>
      <td>${auth.duration}</td>
      <td>${expireTime}</td>
      <td>${auth.localRandom || '...'}</td>
      <td><input type="text" value="${auth.remark || ''}" onblur="window.updateRemark('${row.getAttribute('data-id')}', this.value)"></td>
      <td><button class="delete-btn" onclick="window.deleteAuthCode('${row.getAttribute('data-id')}')">删除</button></td>
    `;
    return row;
  };
  // 5. 倒计时（简化定时器逻辑，避免内存泄漏）
  const startCountdown = () => {
    if (countdownInterval) clearInterval(countdownInterval);
    countdownInterval = setInterval(() => {
      const updateIds = [];
      authCache.forEach(auth => {
        if (auth.durationType === 'permanent' || auth.status === '已过期') return;
        const { isExpired } = getAuthInfo(auth);
        if (isExpired && auth.status !== '已过期') {
          auth.status = '已过期';
          updateIds.push(auth.id);
        }
      });
      if (updateIds.length > 0) {
        const updates = {};
        updateIds.forEach(id => updates[`authCodes/${id}/status`] = '已过期');
        updateIds.forEach(id => {
          const auth = authCache.find(item => item.id === id);
          if (auth) updates[`authCodesByCode/${auth.code}/status`] = '已过期';
        });
        update(ref(db), updates).catch(err => console.error('过期更新失败：', err));
        updateIds.forEach(id => renderTable(id));
      } else {
        // 仅更新文本，不重绘行
        document.querySelectorAll('.countdown.active').forEach(el => {
          const authId = el.closest('tr')?.getAttribute('data-id');
          if (!authId) return;
          const auth = authCache.find(item => item.id === authId);
          if (auth) el.textContent = getAuthInfo(auth).remainingTime;
        });
      }
    }, 500); // 延长定时器间隔，减少性能消耗
  };
  // 6. 实时监听（核心优化：新增2个监听，实现多人同步+状态自动更新）
  const startRealTimeAuthListener = () => {
    const loading = document.getElementById('loading');
    if (!loading) return;
    loading.style.display = 'block';

    // 监听1：初始化全量数据（首次进入加载已有授权码）
    onValue(authRef, (snapshot) => {
      authCache = [];
      existingCodes.clear();
      snapshot.forEach(child => {
        const authData = child.val();
        authCache.push({
          id: child.key,
          code: authData.code,
          durationType: authData.durationType || (authData.duration === '永久' ? 'permanent' : 'day'),
          duration: authData.duration || (authData.durationType === 'permanent' ? '永久' : `${{ day: 1, week: 7, month: 30 }[authData.durationType]}天`),
          localRandom: authData.localRandom || '',
          remark: authData.remark || '',
          isUsed: authData.isUsed ?? false,
          firstUseTime: authData.firstUseTime || '未使用',
          expireTime: authData.expireTime || '',
          status: authData.status || '未使用'
        });
        existingCodes.add(authData.code);
      });
      renderTable();
      startCountdown();
      loading.style.display = 'none';
    });

    // 监听2：新增授权码（多人生成时，实时局部插入，无需刷新）
    onChildAdded(authRef, (childSnapshot) => {
      const newAuthData = childSnapshot.val();
      const newAuth = {
        id: childSnapshot.key,
        code: newAuthData.code,
        durationType: newAuthData.durationType || (newAuthData.duration === '永久' ? 'permanent' : 'day'),
        duration: newAuthData.duration || (newAuthData.durationType === 'permanent' ? '永久' : `${{ day: 1, week: 7, month: 30 }[newAuthData.durationType]}天`),
        localRandom: newAuthData.localRandom || '',
        remark: newAuthData.remark || '',
        isUsed: newAuthData.isUsed ?? false,
        firstUseTime: newAuthData.firstUseTime || '未使用',
        expireTime: newAuthData.expireTime || '',
        status: newAuthData.status || '未使用'
      };
      // 避免重复添加（本地生成的临时码已渲染，数据库同步后不重复）
      if (!authCache.some(auth => auth.id === newAuth.id)) {
        authCache.unshift(newAuth);
        existingCodes.add(newAuth.code);
        renderTable('', newAuth); // 直接插入新行，不用刷新页面
      }
    });

    // 监听3：单个授权码变更（使用/过期等，实时更新状态）
    onChildChanged(authRef, (childSnapshot) => {
      const updatedAuthId = childSnapshot.key;
      const updatedAuthData = childSnapshot.val();
      const authIndex = authCache.findIndex(auth => auth.id === updatedAuthId);
      
      if (authIndex !== -1) {
        // 合并更新数据（保留本地缓存，补充数据库变更字段）
        const updatedAuth = {
          ...authCache[authIndex],
          isUsed: updatedAuthData.isUsed ?? authCache[authIndex].isUsed,
          firstUseTime: updatedAuthData.firstUseTime || authCache[authIndex].firstUseTime,
          expireTime: updatedAuthData.expireTime || authCache[authIndex].expireTime,
          status: updatedAuthData.status || authCache[authIndex].status
        };
        authCache[authIndex] = updatedAuth;
        renderTable(updatedAuthId); // 仅更新变化的行，视觉无感知
      }
    });
  };
  // 7. 生成授权码（核心修复：移除Web Worker，简化乐观更新）
  const generateAuthCode = async () => {
    const user = auth.currentUser;
    if (!user || user.uid !== CONFIG.ADMIN_UID) {
      alert("请先登录管理员账号！");
      return;
    }
    // 防重复点击：立即禁用按钮+显示加载态
    const generateBtn = document.getElementById('generateBtn');
    const loading = document.getElementById('loading');
    if (!generateBtn || !loading) return;
    generateBtn.disabled = true;
    generateBtn.textContent = '生成中...';
    loading.style.display = 'block';
    try {
      // 步骤1：快速生成唯一码（主线程高效处理，无阻塞）
      const newCode = getUniqueAuthCode();
      const type = document.getElementById('authType').value;
      const durationText = type === 'permanent' ? '永久' : `${{ day: 1, week: 7, month: 30 }[type]}天`;
      
      // 步骤2：构造完整授权码数据
      const newAuth = {
        code: newCode,
        durationType: type,
        duration: durationText,
        localRandom: generateRandom('local'),
        remark: '',
        isUsed: false,
        firstUseTime: '未使用',
        expireTime: '',
        status: '未使用'
      };
      // 步骤3：先更新UI（乐观更新，0.1秒内响应）
      authCache.unshift(newAuth);
      existingCodes.add(newCode);
      renderTable('', newAuth);
      // 步骤4：异步写入数据库（非阻塞，不影响UI）
      const newRef = await push(authRef, newAuth);
      newAuth.id = newRef.key; // 补充数据库生成的ID
      await set(ref(db, `authCodesByCode/${newCode}`), newAuth);
      // 步骤5：更新缓存中的ID（确保后续删除正常）
      authCache[0].id = newAuth.id;
      renderTable(newAuth.id); // 仅更新ID，无感知
      // 步骤6：复制+弹窗（延迟100ms，避免视觉太快）
      await new Promise(resolve => setTimeout(resolve, 100));
      currentCode = newCode;
      try {
        await navigator.clipboard.writeText(newCode);
        document.getElementById('copyTip').textContent = '已自动复制到剪贴板';
      } catch {
        document.getElementById('copyTip').textContent = '自动复制失败，可点击重新复制';
      }
      document.getElementById('currentAuthCode').textContent = newCode;
      document.getElementById('codeToast').style.display = 'block';
    } catch (err) {
      // 失败回滚：移除新增的行
      authCache.shift();
      existingCodes.delete(currentCode);
      const firstRow = document.querySelector('#authTableBody tr:first-child');
      if (firstRow) firstRow.remove();
      alert(`生成失败：${err.message || '网络异常，请重试'}`);
    } finally {
      // 恢复交互（无论成功失败都执行）
      if (generateBtn) {
        generateBtn.disabled = false;
        generateBtn.textContent = '生成授权码';
      }
      if (loading) loading.style.display = 'none';
    }
  };
  // 8. 核心功能模块（简化删除逻辑，确保删除即消失）
  window.__authModule = {
    deleteAuthCode: async (authId) => {
      // 过滤临时行（避免删除未写入数据库的临时码）
      if (authId.startsWith('temp-')) {
        alert('临时授权码无需删除，生成失败已自动清理');
        const tempRow = document.querySelector(`tr[data-id="${authId}"]`);
        if (tempRow) tempRow.remove();
        return;
      }
      if (!confirm('确定删除此授权码？删除后不可恢复！')) return;
      // 防重复删除：禁用按钮+显示加载态
      const deleteBtn = document.querySelector(`tr[data-id="${authId}"] .delete-btn`);
      const loading = document.getElementById('loading');
      if (deleteBtn) deleteBtn.disabled = true;
      if (loading) loading.style.display = 'block';
      try {
        // 步骤1：先删除UI（即时消失，无卡顿）
        const delRow = document.querySelector(`tr[data-id="${authId}"]`);
        if (delRow) delRow.remove();
        // 步骤2：查找缓存数据
        const delIndex = authCache.findIndex(auth => auth.id === authId);
        if (delIndex === -1) throw new Error('未找到该授权码');
        const delAuth = authCache[delIndex];
        // 步骤3：删除数据库双节点（确保彻底移除）
        await Promise.all([
          remove(ref(db, `authCodes/${authId}`)),
          remove(ref(db, `authCodesByCode/${delAuth.code}`))
        ]);
        // 步骤4：更新缓存
        authCache.splice(delIndex, 1);
        existingCodes.delete(delAuth.code);
        alert('删除成功！');
      } catch (err) {
        // 失败回滚：重新渲染该行
        const delAuth = authCache.find(auth => auth.id === authId);
        if (delAuth) renderTable('', delAuth);
        alert(`删除失败：${err.message || '网络异常，请重试'}`);
      } finally {
        // 恢复交互
        if (deleteBtn) deleteBtn.disabled = false;
        if (loading) loading.style.display = 'none';
      }
    },
    copyCurrentCode: async () => {
      if (!currentCode) {
        alert('暂无生成的授权码');
        return;
      }
      try {
        await navigator.clipboard.writeText(currentCode);
        document.getElementById('copyTip').textContent = '复制成功！';
      } catch {
        document.getElementById('copyTip').textContent = '复制失败，请手动复制';
      }
    },
    updateRemark: async (authId, remark) => {
      // 过滤临时行
      if (authId.startsWith('temp-')) return;
      try {
        const auth = authCache.find(item => item.id === authId);
        if (auth) {
          await Promise.all([
            update(ref(db, `authCodes/${authId}`), { remark }),
            update(ref(db, `authCodesByCode/${auth.code}`), { remark })
          ]);
          auth.remark = remark;
        }
      } catch (err) {
        alert(`备注保存失败：${err.message || '网络异常'}`);
      }
    },
    verifyAuthCode: async (code) => {
      if (!code || code.trim().length !== 16) {
        window.onVerifyResult(false, '请输入16位授权码！');
        return;
      }
      code = code.trim();
      const loading = document.getElementById('loading');
      if (loading) loading.style.display = 'block';
      try {
        let targetAuth = authCache.find(item => item.code === code);
        let targetAuthId = targetAuth?.id;
        
        if (!targetAuth) {
          const codeSnapshot = await get(ref(db, `authCodesByCode/${code}`));
          if (codeSnapshot.exists()) {
            targetAuth = codeSnapshot.val();
            targetAuthId = targetAuth.id;
          }
        }
        if (!targetAuth) throw new Error('授权码不存在！');
        if (targetAuth.status === '已过期') throw new Error('授权码已过期，无法使用！');
        
        let successMsg = '';
        const isPermanent = targetAuth.durationType === 'permanent';
        
        if (!targetAuth.isUsed) {
          const useTime = getCurrentTime();
          const expireTime = isPermanent ? '永久有效' : new Date(useTime);
          if (!isPermanent) {
            const daysMap = { day:1, week:7, month:30 };
            expireTime.setDate(expireTime.getDate() + daysMap[targetAuth.durationType]);
            expireTime = expireTime.toLocaleString('zh-CN', {
              year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'
            });
          }
          const updateData = {
            isUsed: true,
            firstUseTime: useTime,
            expireTime: expireTime,
            status: '已使用'
          };
          // 更新数据库（触发onChildChanged，实现状态自动同步）
          await Promise.all([
            update(ref(db, `authCodes/${targetAuthId}`), updateData),
            update(ref(db, `authCodesByCode/${code}`), updateData)
          ]);
          // 更新本地缓存和UI（当前页面即时显示）
          const authIndex = authCache.findIndex(item => item.id === targetAuthId);
          if (authIndex !== -1) {
            authCache[authIndex] = { ...authCache[authIndex], ...updateData };
            renderTable(targetAuthId);
          }
          successMsg = isPermanent 
            ? `验证成功！授权码【${code}】永久有效` 
            : `验证成功！首次使用时间：${useTime}\n到期时间：${expireTime}`;
        } else {
          const authInfo = getAuthInfo(targetAuth);
          successMsg = isPermanent 
            ? `验证成功！授权码【${code}】永久有效` 
            : `验证成功！剩余时间：${authInfo.remainingTime}\n到期时间：${authInfo.expireTime}`;
        }
        window.onVerifyResult(true, successMsg);
        startCountdown();
      } catch (err) {
        window.onVerifyResult(false, `验证失败：${err.message || '网络异常'}`);
      } finally {
        if (loading) loading.style.display = 'none';
      }
    }
  };
  // 9. 登录逻辑（简化校验，确保登录正常）
  window.handleLogin = async () => {
    const email = document.getElementById('loginEmail')?.value.trim();
    const pwd = document.getElementById('loginPwd')?.value.trim();
    const tip = document.getElementById('loginTip');
    if (!email || !pwd || !tip) {
      if (tip) tip.textContent = '请填写完整信息！';
      return;
    }
    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, pwd);
      const user = userCredential.user;
      
      if (user.uid !== CONFIG.ADMIN_UID) {
        tip.textContent = '无管理员权限！';
        return;
      }
      // 登录成功：切换界面+启动监听
      document.getElementById('loginPanel').style.display = 'none';
      document.getElementById('generateArea').style.display = 'flex';
      document.getElementById('tableContainer').style.display = 'block';
      startRealTimeAuthListener();
    } catch (err) {
      const errMsg = err.message.includes('wrong-password') ? '密码错误' : 
                    err.message.includes('user-not-found') ? '邮箱未注册' : 
                    err.message.includes('invalid-email') ? '邮箱格式错误' : '登录失败';
      tip.textContent = errMsg;
    }
  };
  // 10. 页面初始化（简化逻辑，避免DOM未加载报错）
  document.addEventListener('DOMContentLoaded', () => {
    const generateBtn = document.getElementById('generateBtn');
    if (generateBtn) {
      generateBtn.addEventListener('click', generateAuthCode);
    }
    // 监听登录状态（刷新页面自动恢复）
    onAuthStateChanged(auth, async (user) => {
      if (user && user.uid === CONFIG.ADMIN_UID) {
        document.getElementById('loginPanel').style.display = 'none';
        document.getElementById('generateArea').style.display = 'flex';
        document.getElementById('tableContainer').style.display = 'block';
        startRealTimeAuthListener();
      } else {
        document.getElementById('loginPanel').style.display = 'block';
        document.getElementById('generateArea').style.display = 'none';
        document.getElementById('tableContainer').style.display = 'none';
        if (countdownInterval) clearInterval(countdownInterval);
      }
    });
    // 页面关闭前清理定时器
    window.addEventListener('beforeunload', () => {
      if (countdownInterval) clearInterval(countdownInterval);
    });
  });
</script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>授权码管理系统</title>
<style>
/* 完整保留原始样式 */
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif}
body{background:#f3f3f3;color:#333;padding:10px}
.generate-area{display:flex;gap:10px;margin:10px 0;align-items:center}
.generate-area select{flex:1;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:14px}
button{background:#7d2ae8;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:14px;margin:0 2px}
button:hover{background:#6b23c2}
button.cancel{background:#dc3545}
button.cancel:hover{background:#bb2d3b}
button.restore{background:#28a745}
button.restore:hover{background:#218838}
.container{width:100%;overflow-x:auto}
table{width:100%;min-width:800px;border-collapse:collapse;margin:10px 0}
th,td{padding:8px 6px;text-align:left;border:1px solid #ddd;font-size:14px;word-break:break-word}
th{background:#e9d5ff;position:sticky;top:0;z-index:1}
.status{padding:2px 6px;border-radius:4px;color:#fff;font-size:12px;display:inline-block}
.unbound{background:#4ecdc4}/*未绑定（未激活）*/
.bound{background:#17a2b8}/*已绑定（激活中）*/
.expired{background:#ffc107;color:#333}/*已过期*/
.permanent{background:#7d2ae8}/*永久有效*/
.invalid{background:#dc3545}/*已取消（暂停）*/
input[type=text]{width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:4px;font-size:13px}
</style>
</head>
<body>
<div class="generate-area">
<select id="authType">
<option value="permanent">永久授权</option>
<option value="day">1天授权</option>
<option value="week">7天授权</option>
<option value="month">30天授权</option>
</select>
<button id="generateBtn">生成授权码</button>
</div>
<div class="container">
<table>
<thead>
<tr>
<th>授权码</</th>
<th>状态</</th>
<th>时长</</th>
<th>到期时间</</th>
<th>本地随机码</</th>
<th>备注</</th>
<th>管理操作</</th>
</tr>
</thead>
<tbody id="authTableBody"></tbody>
</table>
</div>

<!-- 核心：Firebase 模块 + 所有功能逻辑（事件监听版） -->
<script type="module">
  // 1. 导入 Firebase 所需模块
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
  import { getDatabase, ref, push, get, update } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

  // 2. 初始化 Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBd88UKHBOUpyHCtMXt1vliPN_F_9-Eh-0",
    authDomain: "card-verify-system.firebaseapp.com",
    databaseURL: "https://card-verify-system-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "card-verify-system",
    storageBucket: "card-verify-system.firebasestorage.app",
    messagingSenderId: "868161283502",
    appId: "1:868161283502:web:dcb52c1ce9074eb103143f",
    measurementId: "G-TEE7RMEVSE"
  };
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getDatabase(app);
  const authRef = ref(db, "authCodes");
  let authData = [];

  // 3. 工具函数：生成16位授权码
  function generateRandomCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let code = '';
    for (let i = 0; i < 16; i++) {
      code += chars[Math.floor(Math.random() * chars.length)];
    }
    return code;
  }

  // 4. 工具函数：生成6位本地随机码
  function generateLocalRandom() {
    const chars = '0123456789';
    let localCode = '';
    for (let i = 0; i < 6; i++) {
      localCode += chars[Math.floor(Math.random() * chars.length)];
    }
    return localCode;
  }

  // 5. 工具函数：计算到期时间
  function getExpireTime(type) {
    const now = new Date();
    if (type === 'permanent') return '永久有效';
    if (type === 'day') now.setDate(now.getDate() + 1);
    if (type === 'week') now.setDate(now.getDate() + 7);
    if (type === 'month') now.setDate(now.getDate() + 30);
    return now.toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
  }

  // 6. 工具函数：匹配状态样式
  function getStatusClass(status, isPermanent) {
    if (isPermanent) return 'permanent';
    if (status === '未绑定') return 'unbound';
    if (status === '已绑定') return 'bound';
    if (status === '已过期') return 'expired';
    if (status === '已取消') return 'invalid';
    return 'unbound';
  }

  // 7. 核心功能1：生成授权码并写入数据库
  function generateAuthCode() {
    const type = document.getElementById('authType').value;
    const authCode = {
      code: generateRandomCode(),
      status: '未绑定',
      duration: type === 'permanent' ? '永久' : type === 'day' ? '1天' : type === 'week' ? '7天' : '30天',
      expireTime: getExpireTime(type),
      localRandom: generateLocalRandom(),
      remark: ''
    };

    push(authRef, authCode)
      .then(() => {
        alert(`授权码生成成功：${authCode.code}`);
        loadAuthCodes();
      })
      .catch(err => {
        alert(`生成失败：${err.message}`);
        console.error(err);
      });
  }

  // 8. 核心功能2：加载授权码并渲染表格
  function loadAuthCodes() {
    const tableBody = document.getElementById('authTableBody');
    tableBody.innerHTML = '';
    authData = [];

    get(authRef)
      .then(snapshot => {
        snapshot.forEach(childSnapshot => {
          const auth = childSnapshot.val();
          auth.id = childSnapshot.key;
          authData.push(auth);

          const isPermanent = auth.duration === '永久';
          const statusText = !isPermanent && new Date(auth.expireTime) < new Date() ? '已过期' : auth.status;

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${auth.code}</td>
            <td><span class="status ${getStatusClass(statusText, isPermanent)}">${statusText}</span></td>
            <td>${auth.duration}</td>
            <td>${auth.expireTime}</td>
            <td>${auth.localRandom}</td>
            <td><input type="text" value="${auth.remark || ''}" onblur="window.updateRemark('${auth.id}', this.value)"></td>
            <td>
              <button onclick="window.updateStatus('${auth.id}', '已绑定')">激活</button>
              <button class="cancel" onclick="window.updateStatus('${auth.id}', '已取消')">取消</button>
              <button class="restore" onclick="window.updateStatus('${auth.id}', '未绑定')">恢复</button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      })
      .catch(err => {
        alert(`加载失败：${err.message}`);
        console.error(err);
      });
  }

  // 9. 核心功能3：更新授权码状态
  function updateStatus(authId, newStatus) {
    const targetRef = ref(db, `authCodes/${authId}`);
    update(targetRef, { status: newStatus })
      .then(() => loadAuthCodes())
      .catch(err => alert(`状态更新失败：${err.message}`));
  }

  // 10. 核心功能4：更新备注
  function updateRemark(authId, remark) {
    const targetRef = ref(db, `authCodes/${authId}`);
    update(targetRef, { remark: remark })
      .catch(err => alert(`备注保存失败：${err.message}`));
  }

  // 11. 页面加载后：绑定“生成授权码”按钮的点击事件
  document.addEventListener('DOMContentLoaded', () => {
    const generateBtn = document.getElementById('generateBtn');
    generateBtn.addEventListener('click', generateAuthCode);
    loadAuthCodes(); // 页面加载时自动加载已有授权码
  });

  // 12. 暴露部分函数到window（供表格内onclick调用）
  window.updateStatus = updateStatus;
  window.updateRemark = updateRemark;
</script>
</body>
</html>
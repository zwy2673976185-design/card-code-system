<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>授权码管理系统（首次使用计时版）</title>
<style>
/* 保持原样式，确保状态切换视觉清晰 */
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif}
body{background:#f3f3f3;color:#333;padding:10px}
.login-panel{background:#fff;padding:15px;border-radius:4px;margin:10px 0;display:block}
.login-panel h3{font-size:15px;margin-bottom:10px;color:#333}
.login-input{width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:14px;margin-bottom:8px}
.login-btn{width:100%;background:#7d2ae8;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:14px;margin-top:5px}
.login-btn:hover{background:#6b23c2}
.login-tip{font-size:12px;color:#dc3545;margin-top:8px;text-align:center}
.generate-area{display:none;gap:10px;margin:10px 0;align-items:center}
.generate-area select{flex:1;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:14px}
button{background:#7d2ae8;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:14px}
button:hover{background:#6b23c2}
button.delete-btn{background:#dc3545}
button.delete-btn:hover{background:#bb2d3b}
button:disabled{background:#ccc;cursor:not-allowed;opacity:0.7}
.container{width:100%;overflow-x:auto;display:none}
table{width:100%;min-width:900px;border-collapse:collapse;margin:10px 0}
th,td{padding:8px 6px;text-align:left;border:1px solid #ddd;font-size:14px;word-break:break-word}
th{background:#e9d5ff;position:sticky;top:0;z-index:1}
.status{padding:2px 6px;border-radius:4px;color:#fff;font-size:12px;display:inline-block}
.unbound{background:#4ecdc4}
.bound{background:#17a2b8}
.expired{background:#ffc107;color:#333}
.permanent{background:#7d2ae8}
.use-status{padding:2px 6px;border-radius:4px;font-size:12px;display:inline-block}
.used{background:#28a745;color:#fff}
.unused{background:#6c757d;color:#fff}
.countdown{font-family:monospace;color:#dc3545;font-weight:500}
.countdown.expired{color:#dc3545}
.countdown.active{color:#28a745}
input[type=text]{width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:4px;font-size:13px}
#codeToast {position:fixed;bottom:20px;right:20px;background:white;border:1px solid #eee;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);padding:12px 16px;width:320px;z-index:100;display:none}
#codeToast .title{font-size:14px;color:#333;margin-bottom:8px;font-weight:500}
#codeToast .auth-code{font-family:monospace;font-size:16px;color:#7d2ae8;padding:6px 10px;background:#f9f5ff;border-radius:4px;margin-bottom:10px;word-break:break-all}
#codeToast .tip{font-size:12px;color:#666;margin-bottom:10px}
#codeToast .btn-group{display:flex;gap:8px;justify-content:flex-end}
#codeToast .btn-group button{padding:4px 10px;font-size:12px}
#loading{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.5);color:white;padding:8px 16px;border-radius:4px;font-size:14px;z-index:200;display:none}
</style>
</head>
<body>
<!-- 登录面板 -->
<div class="login-panel" id="loginPanel">
  <h3>管理员登录</h3>
  <input type="email" id="loginEmail" class="login-input" placeholder="Firebase邮箱">
  <input type="password" id="loginPwd" class="login-input" placeholder="Firebase密码">
  <button class="login-btn" onclick="handleLogin()">登录</button>
  <div class="login-tip" id="loginTip"></div>
</div>
<!-- 生成+表格区域 -->
<div class="generate-area" id="generateArea">
<select id="authType">
<option value="permanent">永久授权</option>
<option value="day">1天授权</option>
<option value="week">7天授权</option>
<option value="month">30天授权</option>
</select>
<button id="generateBtn">生成授权码</button>
</div>
<div class="container" id="tableContainer">
<table>
<thead>
<tr>
<th>授权码</</th>
<th>使用状态</</th>
<th>首次使用时间</</th>
<th>剩余时间（精确到秒）</</th>
<th>状态</</th>
<th>时长</</th>
<th>到期时间</</th>
<th>本地随机码</</th>
<th>备注</</th>
<th>管理操作</</th>
</tr>
</thead>
<tbody id="authTableBody"></tbody>
</table>
</div>
<!-- 弹窗 -->
<div id="codeToast">
  <div class="title">授权码生成成功</div>
  <div class="auth-code" id="currentAuthCode"></div>
  <div class="tip" id="copyTip">已自动复制到剪贴板</div>
  <div class="btn-group">
    <button onclick="window.copyCurrentCode()">重新复制</button>
    <button onclick="document.getElementById('codeToast').style.display='none'">关闭</button>
  </div>
</div>
<div id="loading">处理中...</div>
<!-- 全局函数壳 -->
<script>
window.deleteAuthCode = (authId) => window.__authModule?.deleteAuthCode(authId);
window.copyCurrentCode = () => window.__authModule?.copyCurrentCode();
window.updateRemark = (authId, remark) => window.__authModule?.updateRemark(authId, remark);
window.verifyAuthCode = (code) => window.__authModule?.verifyAuthCode(code);
window.onVerifyResult = (success, message) => { alert(message); };
window.__authModule = {};
</script>
<!-- Firebase 核心脚本（聚焦：首次使用变已使用+新码自动刷新） -->
<script type="module">
  // 1. 基础配置（与Firebase项目匹配）
  const CONFIG = {
    FIREBASE: {
      apiKey: "AIzaSyBd88UKHBOUpyHCtMXt1vliPN_F_9-Eh-0",
      authDomain: "card-verify-system.firebaseapp.com",
      databaseURL: "https://card-verify-system-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "card-verify-system",
      storageBucket: "card-verify-system.firebasestorage.app",
      messagingSenderId: "868161283502",
      appId: "1:868161283502:web:dcb52c1ce9074eb103143f",
      measurementId: "G-TEE7RMEVSE"
    },
    ADMIN_UID: "mXN1EXITivUU0ZSdmSroJijmqHU2"
  };

  // 2. 初始化Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getDatabase, ref, push, get, update, remove, set, onValue, onChildAdded, onChildChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
  const app = initializeApp(CONFIG.FIREBASE);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const authRef = ref(db, "authCodes");
  const authByCodeRef = ref(db, "authCodesByCode");

  // 3. 全局变量+工具函数
  let authCache = []; // 授权码缓存（避免重复请求）
  let existingCodes = new Set(); // 已存在的授权码（防重复生成）
  let currentCode = ""; // 当前生成的授权码
  let countdownInterval = null; // 倒计时定时器

  // 生成16位授权码/6位本地随机码
  const generateRandom = (type) => {
    if (type === 'auth') {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      return [...Array(16)].map(() => chars[Math.floor(Math.random() * chars.length)]).join('');
    }
    return [...Array(6)].map(() => Math.floor(Math.random() * 10)).join('');
  };

  // 生成唯一授权码（防重复）
  const getUniqueAuthCode = () => {
    let code;
    do {
      code = generateRandom('auth');
    } while (existingCodes.has(code) && existingCodes.size < 1000);
    return code;
  };

  // 获取格式化时间（用于首次使用/到期时间）
  const getFormattedTime = () => new Date().toLocaleString('zh-CN', {
    year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'
  });

  // 计算剩余时间（首次使用后才开始计时）
  const calcRemainingTime = (auth) => {
    // 未使用：不计时
    if (!auth.isUsed) return '未使用（未计时）';
    // 永久授权：不计时
    if (auth.durationType === 'permanent') return '永久有效';
    // 已过期：显示过期
    if (new Date(auth.expireTime).getTime() <= Date.now()) return '已过期';
    // 计算剩余时间（精确到秒）
    const diff = new Date(auth.expireTime).getTime() - Date.now();
    const days = Math.floor(diff / 86400000);
    const hours = Math.floor((diff % 86400000) / 3600000);
    const minutes = Math.floor((diff % 3600000) / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);
    const pad = (num) => num.toString().padStart(2, '0');
    return `${pad(days)}天${pad(hours)}时${pad(minutes)}分${pad(seconds)}秒`;
  };

  // 4. 表格渲染（仅局部更新，无全量刷新）
  const renderTable = (updateId = '', newAuth = null) => {
    const tableBody = document.getElementById('authTableBody');
    if (!tableBody) return;

    // 场景1：新增授权码（自动刷新显示）
    if (newAuth) {
      const newRow = createAuthRow(newAuth);
      tableBody.prepend(newRow);
      return;
    }

    // 场景2：更新单个授权码（首次使用变已使用）
    if (updateId) {
      const oldRow = tableBody.querySelector(`tr[data-id="${updateId}"]`);
      if (oldRow) {
        const auth = authCache.find(item => item.id === updateId);
        if (auth) oldRow.replaceWith(createAuthRow(auth));
      }
      return;
    }

    // 场景3：初始化全量渲染
    tableBody.innerHTML = '';
    if (authCache.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:20px;color:#666">暂无授权码</td></tr>';
      return;
    }
    const fragment = document.createDocumentFragment();
    authCache.forEach(auth => fragment.appendChild(createAuthRow(auth)));
    tableBody.appendChild(fragment);
  };

  // 创建单个授权码行（状态样式精准匹配）
  const createAuthRow = (auth) => {
    const useStatusCls = auth.isUsed ? 'used' : 'unused';
    const useStatusText = auth.isUsed ? '已使用' : '未使用';
    const remainingTime = calcRemainingTime(auth);
    const statusCls = remainingTime === '已过期' ? 'expired' : (auth.durationType === 'permanent' ? 'permanent' : 'unbound');
    const statusText = remainingTime === '已过期' ? '已过期' : (auth.isUsed ? '已使用' : '未使用');
    const expireTimeText = auth.expireTime || '未生效';

    const row = document.createElement('tr');
    row.setAttribute('data-id', auth.id || `temp-${Date.now()}`);
    row.innerHTML = `
      <td>${auth.code}</td>
      <td><span class="use-status ${useStatusCls}">${useStatusText}</span></td>
      <td>${auth.firstUseTime || '未使用'}</td>
      <td><span class="countdown ${remainingTime !== '未使用（未计时）' && remainingTime !== '永久有效' ? 'active' : ''}">${remainingTime}</span></td>
      <td><span class="status ${statusCls}">${statusText}</span></td>
      <td>${auth.duration}</td>
      <td>${expireTimeText}</td>
      <td>${auth.localRandom || '...'}</td>
      <td><input type="text" value="${auth.remark || ''}" onblur="window.updateRemark('${row.dataset.id}', this.value)" placeholder="备注"></td>
      <td><button class="delete-btn" onclick="window.deleteAuthCode('${row.dataset.id}')">删除</button></td>
    `;
    return row;
  };

  // 5. 倒计时定时器（仅首次使用后启动）
  const startCountdown = () => {
    if (countdownInterval) clearInterval(countdownInterval);
    // 每秒更新一次剩余时间（不重绘行，仅改文本）
    countdownInterval = setInterval(() => {
      document.querySelectorAll('.countdown.active').forEach(el => {
        const authId = el.closest('tr')?.dataset.id;
        if (!authId) return;
        const auth = authCache.find(item => item.id === authId);
        if (auth) el.textContent = calcRemainingTime(auth);
        // 过期后更新状态
        if (el.textContent === '已过期') {
          el.classList.remove('active');
          el.classList.add('expired');
          const auth = authCache.find(item => item.id === authId);
          if (auth && auth.status !== '已过期') {
            update(ref(db, `authCodes/${authId}/status`), '已过期');
            auth.status = '已过期';
          }
        }
      });
    }, 1000);
  };

  // 6. 实时监听（核心：新码自动刷新+首次使用同步）
  const startRealTimeListener = () => {
    const loading = document.getElementById('loading');
    loading.style.display = 'block';

    // 监听1：初始化全量数据（首次登录加载）
    onValue(authRef, (snapshot) => {
      authCache = [];
      existingCodes.clear();
      snapshot.forEach(child => {
        const data = child.val();
        authCache.push({
          id: child.key,
          code: data.code,
          durationType: data.durationType || 'day',
          duration: data.duration || (data.durationType === 'permanent' ? '永久' : `${{ day:1, week:7, month:30 }[data.durationType]}天`),
          localRandom: data.localRandom || '',
          remark: data.remark || '',
          isUsed: data.isUsed ?? false,
          firstUseTime: data.firstUseTime || '',
          expireTime: data.expireTime || '',
          status: data.status || (data.isUsed ? '已使用' : '未使用')
        });
        existingCodes.add(data.code);
      });
      renderTable();
      startCountdown();
      loading.style.display = 'none';
    });

    // 监听2：新增授权码（多人生成自动刷新，无需手动刷新）
    onChildAdded(authRef, (childSnapshot) => {
      const newAuthData = childSnapshot.val();
      const newAuth = {
        id: childSnapshot.key,
        code: newAuthData.code,
        durationType: newAuthData.durationType || 'day',
        duration: newAuthData.duration || (newAuthData.durationType === 'permanent' ? '永久' : `${{ day:1, week:7, month:30 }[newAuthData.durationType]}天`),
        localRandom: newAuthData.localRandom || '',
        remark: newAuthData.remark || '',
        isUsed: newAuthData.isUsed ?? false,
        firstUseTime: newAuthData.firstUseTime || '',
        expireTime: newAuthData.expireTime || '',
        status: newAuthData.status || '未使用'
      };
      // 防重复添加（本地生成的已渲染，只加数据库新增的）
      if (!authCache.some(a => a.id === newAuth.id)) {
        authCache.unshift(newAuth);
        existingCodes.add(newAuth.code);
        renderTable('', newAuth); // 直接插入新行，自动刷新
      }
    });

    // 监听3：首次使用状态变更（实时变已使用，启动计时）
    onChildChanged(authRef, (childSnapshot) => {
      const updateId = childSnapshot.key;
      const updateData = childSnapshot.val();
      const authIndex = authCache.findIndex(a => a.id === updateId);
      
      if (authIndex !== -1) {
        // 重点：仅处理“首次使用”的变更（isUsed从false→true）
        if (updateData.isUsed && !authCache[authIndex].isUsed) {
          authCache[authIndex] = {
            ...authCache[authIndex],
            isUsed: true,
            firstUseTime: updateData.firstUseTime,
            expireTime: updateData.expireTime,
            status: '已使用'
          };
          renderTable(updateId); // 局部更新，状态变已使用
          startCountdown(); // 重启倒计时，确保新状态计时
        }
      }
    });
  };

  // 7. 生成授权码（自动刷新依赖监听2，无需额外操作）
  const generateAuthCode = async () => {
    const user = auth.currentUser;
    if (!user || user.uid !== CONFIG.ADMIN_UID) {
      alert("请先登录管理员账号！");
      return;
    }

    const generateBtn = document.getElementById('generateBtn');
    const loading = document.getElementById('loading');
    generateBtn.disabled = true;
    generateBtn.textContent = '生成中...';
    loading.style.display = 'block';

    try {
      // 生成唯一码+构造数据
      const newCode = getUniqueAuthCode();
      const type = document.getElementById('authType').value;
      const durationText = type === 'permanent' ? '永久' : `${{ day:1, week:7, month:30 }[type]}天`;
      const newAuth = {
        code: newCode,
        durationType: type,
        duration: durationText,
        localRandom: generateRandom('local'),
        remark: '',
        isUsed: false, // 初始未使用
        firstUseTime: '',
        expireTime: '',
        status: '未使用'
      };

      // 乐观更新UI（先显示，再写库）
      authCache.unshift(newAuth);
      existingCodes.add(newCode);
      renderTable('', newAuth);

      // 写入数据库（触发监听2，多端自动同步）
      const newRef = await push(authRef, newAuth);
      newAuth.id = newRef.key;
      await set(ref(db, `authCodesByCode/${newCode}`), newAuth);

      // 补全ID，确保后续操作正常
      authCache[0].id = newAuth.id;
      renderTable(newAuth.id);

      // 弹窗+复制
      await new Promise(resolve => setTimeout(resolve, 100));
      currentCode = newCode;
      try {
        await navigator.clipboard.writeText(newCode);
        document.getElementById('copyTip').textContent = '已自动复制到剪贴板';
      } catch {
        document.getElementById('copyTip').textContent = '自动复制失败，可点击重新复制';
      }
      document.getElementById('currentAuthCode').textContent = newCode;
      document.getElementById('codeToast').style.display = 'block';

    } catch (err) {
      // 失败回滚
      authCache.shift();
      existingCodes.delete(currentCode);
      document.querySelector('#authTableBody tr:first-child')?.remove();
      alert(`生成失败：${err.message || '网络异常'}`);
    } finally {
      generateBtn.disabled = false;
      generateBtn.textContent = '生成授权码';
      loading.style.display = 'none';
    }
  };

  // 8. 核心功能（聚焦首次使用验证）
  window.__authModule = {
    // 删除功能（不变）
    deleteAuthCode: async (authId) => {
      if (authId.startsWith('temp-')) {
        alert('临时码无需删除');
        document.querySelector(`tr[data-id="${authId}"]`)?.remove();
        return;
      }
      if (!confirm('确定删除？删除后不可恢复！')) return;

      const deleteBtn = document.querySelector(`tr[data-id="${authId}"] .delete-btn`);
      const loading = document.getElementById('loading');
      deleteBtn.disabled = true;
      loading.style.display = 'block';

      try {
        const delIndex = authCache.findIndex(a => a.id === authId);
        if (delIndex === -1) throw new Error('未找到该授权码');
        const delAuth = authCache[delIndex];

        // 删除UI+数据库
        document.querySelector(`tr[data-id="${authId}"]`).remove();
        await Promise.all([
          remove(ref(db, `authCodes/${authId}`)),
          remove(ref(db, `authCodesByCode/${delAuth.code}`))
        ]);

        authCache.splice(delIndex, 1);
        existingCodes.delete(delAuth.code);
        alert('删除成功！');
      } catch (err) {
        alert(`删除失败：${err.message || '网络异常'}`);
      } finally {
        deleteBtn.disabled = false;
        loading.style.display = 'none';
      }
    },

    // 复制功能（不变）
    copyCurrentCode: async () => {
      if (!currentCode) {
        alert('暂无生成的授权码');
        return;
      }
      try {
        await navigator.clipboard.writeText(currentCode);
        document.getElementById('copyTip').textContent = '复制成功！';
      } catch {
        document.getElementById('copyTip').textContent = '请手动复制';
      }
    },

    // 备注功能（不变）
    updateRemark: async (authId, remark) => {
      if (authId.startsWith('temp-')) return;
      try {
        const auth = authCache.find(a => a.id === authId);
        if (auth) {
          await Promise.all([
            update(ref(db, `authCodes/${authId}/remark`), remark),
            update(ref(db, `authCodesByCode/${auth.code}/remark`), remark)
          ]);
          auth.remark = remark;
        }
      } catch (err) {
        alert(`备注保存失败：${err.message}`);
      }
    },

    // 关键：验证授权码（首次使用触发状态变更）
    verifyAuthCode: async (code) => {
      if (!code || code.trim().length !== 16) {
        window.onVerifyResult(false, '请输入16位授权码！');
        return;
      }
      code = code.trim();
      const loading = document.getElementById('loading');
      loading.style.display = 'block';

      try {
        // 查授权码（先查缓存，再查库）
        let targetAuth = authCache.find(a => a.code === code);
        let targetAuthId = targetAuth?.id;
        if (!targetAuth) {
          const codeSnap = await get(ref(db, `authCodesByCode/${code}`));
          if (!codeSnap.exists()) throw new Error('授权码不存在！');
          targetAuth = codeSnap.val();
          targetAuthId = targetAuth.id;
        }

        // 已过期/已使用校验
        if (targetAuth.status === '已过期') throw new Error('授权码已过期！');
        if (targetAuth.isUsed) {
          // 已使用：仅返回状态，不更新
          const remainingTime = calcRemainingTime(targetAuth);
          window.onVerifyResult(true, `授权码已使用！剩余时间：${remainingTime}`);
          return;
        }

        // 核心：首次使用，更新状态（触发监听3）
        const useTime = getFormattedTime();
        const durationMap = { day:1, week:7, month:30 };
        const expireTime = targetAuth.durationType === 'permanent' 
          ? '永久有效' 
          : new Date(useTime);
        if (targetAuth.durationType !== 'permanent') {
          expireTime.setDate(expireTime.getDate() + durationMap[targetAuth.durationType]);
          expireTime = expireTime.toLocaleString('zh-CN', {
            year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'
          });
        }

        // 更新数据库（isUsed从false→true，触发状态同步）
        const updateData = {
          isUsed: true,
          firstUseTime: useTime,
          expireTime: expireTime,
          status: '已使用'
        };
        await Promise.all([
          update(ref(db, `authCodes/${targetAuthId}`), updateData),
          update(ref(db, `authCodesByCode/${code}`), updateData)
        ]);

        // 本地缓存更新（当前页面即时显示）
        const authIndex = authCache.findIndex(a => a.id === targetAuthId);
        if (authIndex !== -1) {
          authCache[authIndex] = { ...authCache[authIndex], ...updateData };
          renderTable(targetAuthId);
        }

        // 提示结果
        window.onVerifyResult(true, `首次使用成功！\n首次使用时间：${useTime}\n到期时间：${expireTime}`);
        startCountdown(); // 重启倒计时，确保计时生效

      } catch (err) {
        window.onVerifyResult(false, `验证失败：${err.message || '网络异常'}`);
      } finally {
        loading.style.display = 'none';
      }
    }
  };

  // 9. 登录逻辑（不变）
  window.handleLogin = async () => {
    const email = document.getElementById('loginEmail')?.value.trim();
    const pwd = document.getElementById('loginPwd')?.value.trim();
    const tip = document.getElementById('loginTip');
    if (!email || !pwd || !tip) {
      tip.textContent = '请填写完整信息！';
      return;
    }

    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, pwd);
      const user = userCredential.user;
      if (user.uid !== CONFIG.ADMIN_UID) {
        tip.textContent = '无管理员权限！';
        return;
      }

      // 登录成功：显示界面+启动监听（自动同步数据）
      document.getElementById('loginPanel').style.display = 'none';
      document.getElementById('generateArea').style.display = 'flex';
      document.getElementById('tableContainer').style.display = 'block';
      startRealTimeListener();

    } catch (err) {
      const errMsg = err.message.includes('wrong-password') ? '密码错误' : 
                    err.message.includes('user-not-found') ? '邮箱未注册' : 
                    err.message.includes('invalid-email') ? '邮箱格式错误' : '登录失败';
      tip.textContent = errMsg;
    }
  };

  // 10. 页面初始化（清理定时器）
  document.addEventListener('DOMContentLoaded', () => {
    // 生成按钮点击事件
    document.getElementById('generateBtn').addEventListener('click', generateAuthCode);

    // 登录状态监听（刷新页面自动恢复）
    onAuthStateChanged(auth, (user) => {
      if (user && user.uid === CONFIG.ADMIN_UID) {
        document.getElementById('loginPanel').style.display = 'none';
        document.getElementById('generateArea').style.display = 'flex';
        document.getElementById('tableContainer').style.display = 'block';
        startRealTimeListener();
      } else {
        document.getElementById('loginPanel').style.display = 'block';
        document.getElementById('generateArea').style.display = 'none';
        document.getElementById('tableContainer').style.display = 'none';
        if (countdownInterval) clearInterval(countdownInterval);
      }
    });

    // 页面关闭清理
    window.addEventListener('beforeunload', () => {
      if (countdownInterval) clearInterval(countdownInterval);
    });
  });
</script>
</body>
</html>